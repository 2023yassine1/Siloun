<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOTAL SILOUN MOLINO - Smart AI V4.5 (Firebase Cloud)</title>
    
    <!-- ููุชุจุฉ Chart.js ููุฑุณูู ุงูุจูุงููุฉ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <!-- โ๏ธ ููุชุจุงุช Firebase (Version 8 Compat for easy use) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link rel="manifest" href="molino_app.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3498db">

    <style>
        /* --- ุชูุณููุงุช ุฃุณุงุณูุฉ --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 0; color: #333; text-align: right; }
        .container { padding: 25px; max-width: 700px; margin: 20px auto; background-color: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 12px; }
        h1 { border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 25px; text-align: center; color: #2c3e50; }
        h2 { font-size: 1.2rem; margin-top: 25px; margin-bottom: 15px; border-right: 4px solid #3498db; padding-right: 10px; color: #2c3e50; }
        
        /* --- ุงููุฏุฎูุงุช ูุงูุฃุฒุฑุงุฑ --- */
        input, select, button { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 16px; font-family: 'Segoe UI', sans-serif; }
        input[type="number"] { direction: ltr; text-align: right; }
        button { background-color: #28a745; color: white; cursor: pointer; border: none; font-weight: bold; transition: 0.3s; }
        button:hover { background-color: #218838; transform: translateY(-1px); }
        .secondary-btn { background-color: #6c757d; }
        .danger-btn { background-color: #dc3545; }
        .reset-btn { background-color: #8b0000; color: #ffcccc; margin-top: 10px; border: 1px solid #5a0000;} 
        .small-btn { width: auto; padding: 5px 10px; font-size: 12px; margin: 0; }
        .input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .input-group input, .input-group select { margin-bottom: 0; }

        /* --- ุงูุฌุฏุงูู --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #e9ecef; padding: 8px; text-align: center; }
        th { background-color: #3498db; color: white; }
        td { direction: ltr; unicode-bidi: embed; }

        /* --- ุชุตููู ุงููุคุดุฑุงุช (Gauges) --- */
        .gauge-container { margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa; }
        .gauge-labels { display: flex; justify-content: space-between; direction: ltr; margin-bottom: 8px; }
        .gauge-wrapper { display: flex; align-items: center; gap: 4px; height: 30px; }
        .gauge-main { flex-grow: 1; background-color: #e9ecef; border-radius: 6px 0 0 6px; height: 100%; overflow: hidden; position: relative; }
        .gauge-extension { width: 20%; background-color: #dedede; border-radius: 0 6px 6px 0; height: 100%; overflow: hidden; position: relative; border-left: 2px dashed #bbb; }
        .fill-bar { height: 100%; width: 0%; transition: width 0.6s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; }
        .gauge-sub-labels { display: flex; justify-content: space-between; font-size: 10px; color: #777; margin-top: 4px; }
        .blinking { animation: blinker var(--blink-speed) linear infinite; } @keyframes blinker { 50% { opacity: 0.7; } }

        /* --- ุจุทุงูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู (AI Analysis) --- */
        #ai-card { background: linear-gradient(135deg, #f0f9ff 0%, #e1f5fe 100%); border: 1px solid #b3e5fc; border-radius: 10px; overflow: hidden; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .ai-header { background-color: #0288d1; color: white; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .ai-body { padding: 15px; }
        
        /* ุดุจูุฉ ุงูุฅุญุตุงุฆูุงุช */
        .ai-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .ai-stat-box { background: white; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #b3e5fc; }
        .ai-value { display: block; font-size: 1.1rem; font-weight: bold; color: #0277bd; font-family: sans-serif; }
        .ai-label { font-size: 0.75rem; color: #546e7a; }

        /* ูุงุฆูุฉ ุงูุชูุตูุงุช */
        .ai-insights { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; }
        .ai-insights li { padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: flex-start; gap: 8px; background: rgba(255,255,255,0.6); margin-bottom: 5px; border-radius: 4px; }
        .ai-insights li:last-child { border-bottom: none; }
        
        /* ููุงุฑูุฉ ุงูุฃุฏุงุก */
        .performance-bar-container { margin-top: 15px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 6px; }
        .perf-title { font-size: 0.85rem; color: #455a64; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .perf-progress-bg { height: 8px; background: #cfd8dc; border-radius: 4px; overflow: hidden; }
        .perf-progress-fill { height: 100%; background: #4caf50; width: 0%; transition: width 1s; }

        /* ูุณู ุงูุฅุฏุงุฑุฉ */
        .backup-section { background-color: #f1f1f1; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #ccc; }
        
        /* ุชูุณููุงุช ุตูุญุฉ ุงููุตุงุฏูุฉ */
        #auth-page { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #3498db; }
        .auth-box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 400px; text-align: center; }
        
        /* ุชูุณููุงุช ุตูุญุฉ ุงูุฑุณูู ุงูุจูุงููุฉ ุงููููุตู (Modal) */
        .charts-modal, .settings-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .charts-content, .settings-content { background-color: #fefefe; margin: 2% auto; padding: 20px; width: 95%; max-width: 700px; border-radius: 12px; }
        .charts-content h2 { border-right: 4px solid #ffeb3b; color: #795548; }
        .settings-content h2 { border-right: 4px solid #f44336; color: #f44336; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 25px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        .chart-container h4 { text-align: center; color: #795548; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-bottom: 10px;}

        /* ุฒุฑ ูุงุฆูุฉ ุงูุฎูุงุฑุงุช ูู ุงูุฃุนูู (ุงูุซูุงุซ ููุงุท) */
        .options-menu-btn { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            font-size: 24px; 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: #333; 
            width: auto; 
            padding: 5px;
            margin-bottom: 0;
        }

        /* ุชูุณููุงุช ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช (ุฎุงุต) */
        #settingsForm label { display: block; font-weight: bold; margin-bottom: 5px; margin-top: 10px; }
        .silo-settings-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            align-items: center; 
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            background-color: #fafafa;
            flex-wrap: wrap;
        }
        .silo-settings-row > div { 
            flex: 1 1 45%; /* ูุณูุญ ููุนูุงุตุฑ ุจุงูููู ูุงูุชูุฏุณ */
            min-width: 150px;
        }
        .silo-settings-row input[type="text"], .silo-settings-row input[type="number"] {
            margin-bottom: 0;
            padding: 8px;
            width: 100%;
        }
        .silo-settings-row .silo-name-input {
            flex: 1 1 100%;
        }
        .silo-settings-row .silo-capacity-input {
            display: flex;
            align-items: center;
        }
        .silo-settings-row .silo-capacity-input span {
            flex-shrink: 0;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<!-- ุดุงุดุฉ ุงููุตุงุฏูุฉ -->
<div id="auth-page">
    <div class="auth-box">
        <h2 id="auth-title">ุชุณุฌูู ุงูุฏุฎูู (Firebase) ๐</h2>
        <form id="authForm">
            <label style="display: block; text-align: right; margin-bottom: 5px;">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</label>
            <input type="email" id="emailInput" required placeholder="name@example.com">
            
            <label style="display: block; text-align: right; margin-bottom: 5px;">ูููุฉ ุงููุฑูุฑ:</label>
            <input type="password" id="passwordInput" required placeholder="ูููุฉ ุงููุฑูุฑ">
            
            <p id="authMessage" class="auth-message" style="display: none; padding: 10px; margin-bottom: 10px; border-radius: 5px; font-weight: bold;"></p>
            
            <button type="submit" id="authButton">ุฏุฎูู</button>
            <span id="toggleAuth" class="toggle-link" style="color: #3498db; cursor: pointer; text-decoration: underline;" onclick="toggleAuthMode()">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</span>
        </form>
    </div>
</div>

<!-- ุงูุชุทุจูู ุงูุฑุฆูุณู -->
<div id="main-app" class="container" style="display:none;">
    <button class="options-menu-btn" onclick="showSettingsModal()">โ๏ธ</button>
    
    <h1>๐ญ TOTAL SILOUN MOLINO <span style="font-size:0.5em; color:#777;">AI Cloud V5.0</span></h1>
    <div style="text-align: left; margin-bottom: 15px;">
        <span style="font-size: 0.8em; color: #666;">ูุฑุญุจุงู ุจูุ <strong id="loggedInUser"></strong></span>
        <button class="danger-btn small-btn" onclick="logout()" style="width: auto; margin-right: 10px;">ุฎุฑูุฌ</button>
    </div>

    <hr>
    
    <h2>๐ ุชุณุฌูู ุงูุจูุงูุงุช</h2>
    <form id="entryForm">
        <label>ุงุฎุชูุงุฑ ุงูุฎุฒุงู:</label>
        <select id="silounSelect" required>
            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
        </select>

        <label>ุงููุฒู ุงูุญุงูู (<span id="maxWeightDisplay">Max T</span>):</label>
        <input type="number" id="weightInput" min="0" step="0.01" required placeholder="ูุซุงู: 64.50">
        
        <label>ููุช ุงูุชุณุฌูู:</label>
        <input type="datetime-local" id="dateTimeInput" required>

        <button type="submit">โ ุชุณุฌูู ุงููุฑุงุกุฉ (ุณุญุงุจู)</button>
    </form>
    
    <hr>

    <h2>๐ ุญุงูุฉ ุงูุฎุฒุงูุงุช (ูุจุงุดุฑ)</h2>
    <div id="gauges"></div>
    
    <div id="ai-card">
        <div class="ai-header">
            <span>๐ค ุงูุชุญููู ุงูุฐูู ููุฃุฏุงุก</span>
            <span id="liveStatus" style="font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px;">ุฌุงุฑู ุงูุงุชุตุงู...</span>
        </div>
        <div class="ai-body">
            <div class="ai-stats-grid">
                <div class="ai-stat-box">
                    <span class="ai-value" id="aiSpeed">0.0</span>
                    <span class="ai-label">ุงูุณุฑุนุฉ (ุทู/ุณุงุนุฉ)</span>
                </div>
                <div class="ai-stat-box">
                    <span class="ai-value" id="aiTotal">0.00</span>
                    <span class="ai-label">ุฅูุชุงุฌ ุงูุฌูุณุฉ</span>
                </div>
                <div class="ai-stat-box">
                    <span class="ai-value" id="aiBestDay">-</span>
                    <span class="ai-label">ุฃูุถู ููู (ุณุงุจู)</span>
                </div>
            </div>

            <div class="performance-bar-container">
                <div class="perf-title">
                    <span>ููุงุฑูุฉ ุจูุชูุณุท ุงูุฃุฏุงุก ุงูุชุงุฑูุฎู</span>
                    <span id="compText">0%</span>
                </div>
                <div class="perf-progress-bg">
                    <div id="compBar" class="perf-progress-fill"></div>
                </div>
                <small id="compMessage" style="display:block; margin-top:5px; font-size:0.75rem; color:#666;"></small>
            </div>

            <h4 style="margin: 10px 0 5px 0; font-size: 0.9rem; color: #0277bd;">๐ ุงูุชูุตูุงุช ูุงูููุงุญุธุงุช:</h4>
            <ul class="ai-insights" id="aiInsightsList">
                <li>ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ูุจุฏุก ุงูุชุญููู...</li>
            </ul>
        </div>
    </div>
    
    <hr>
    
    <button class="secondary-btn" onclick="showChartsModal()">๐ ุนุฑุถ ุงูุฑุณูู ุงูุจูุงููุฉ ุงูุชูุงุนููุฉ</button>
    
    <hr>

    <h2>๐ ุงูุณุฌู ุงูุญุงูู</h2>
    <table id="recordsTable">
        <thead>
            <tr><th>ุงูููุช</th><th>ุงูุฎุฒุงู</th><th>ุงููุฒู</th><th>ุงููุฑู</th><th>ุญุฐู</th></tr>
        </thead>
        <tbody id="recordsBody"></tbody>
    </table>

    <hr>

    <div style="display: flex; gap: 10px;">
        <button class="danger-btn" onclick="endWork()" style="flex: 1;">๐ด ุฅููุงุก ูุญูุธ ููุฃุฑุดูู</button>
        <button class="secondary-btn" onclick="viewHistory()" style="flex: 1;">๐ ุงูุฃุฑุดูู ูุงูููุงุฑูุฉ</button>
    </div>

    <div class="backup-section">
        <h3 style="margin-top: 0; font-size: 1rem;">๐พ ุฃุฏูุงุช ุงููุธุงู</h3>
        <p style="font-size:0.8em; color:#666;">ุงูุจูุงูุงุช ูุญููุธุฉ ุชููุงุฆูุงู ูู ุงูุณุญุงุจุฉ (Firebase Cloud).</p>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="secondary-btn small-btn" onclick="exportData()">โฌ๏ธ ุชุญููู Backup ูุญูู</button>
            <input type="file" id="importFile" accept=".json" style="padding: 5px;" onchange="importData(this)">
        </div>
    </div>
</div>

<!-- ุงูููุงูุฐ ุงูููุจุซูุฉ (Modals) -->

<div id="chartsModal" class="charts-modal">
    <div class="charts-content">
        <h2 style="display: flex; justify-content: space-between; align-items: center;">
            <span>๐ ุงูุฑุณูู ุงูุจูุงููุฉ ุงูุชูุงุนููุฉ</span>
            <button class="danger-btn small-btn" onclick="hideChartsModal()" style="margin: 0; width: auto;">ุฅุบูุงู โ๏ธ</button>
        </h2>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="secondary-btn small-btn" onclick="renderAllCharts()">๐ ุชุญุฏูุซ ุงูุฑุณูู ุงูุจูุงููุฉ</button>
        </div>

        <div class="chart-container" style="height: 350px;">
            <h4>ุงูุฃูุฒุงู ุงูุชุฑุงูููุฉ ุงูุญุงููุฉ (T) - ูู ุฎุฒุงู</h4>
            <canvas id="currentWeightsChart"></canvas>
        </div>

        <div class="chart-container" style="height: 350px;">
            <h4>ูุฑููุงุช ุงูุฃูุฒุงู (ุทู) - ุงูุฌูุณุฉ ุงูุญุงููุฉ</h4>
            <canvas id="currentDifferencesChart"></canvas>
        </div>
        
        <div class="chart-container" style="height: 350px;">
            <h4>ุฅุฌูุงูู ุงูุฅูุชุงุฌ ุงููููู (T) - ุงูุฃุฑุดูู</h4>
            <canvas id="historyTotalChart"></canvas>
        </div>
        
        <div class="chart-container" style="height: 350px;">
            <h4>ูุชูุณุท ุณุฑุนุฉ ุงูุฅูุชุงุฌ (T/h) - ุงูุฃุฑุดูู</h4>
            <canvas id="historySpeedChart"></canvas>
        </div>
    </div>
</div>

<div id="settingsModal" class="settings-modal">
    <div class="settings-content">
        <h2 style="display: flex; justify-content: space-between; align-items: center;">
            <span>โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุตูุน ุงููุชูุฏูุฉ (Firebase)</span>
            <button class="danger-btn small-btn" onclick="hideSettingsModal()" style="margin: 0; width: auto;">ุฅุบูุงู โ๏ธ</button>
        </h2>
        
        <div id="admin-access-warning" style="display:none; background:#ffebee; color:#c62828; padding:10px; margin-bottom:15px; border-radius:5px;">
            โ๏ธ <strong>ุชูุจูู:</strong> ุฃูุช ูุณุช ุงููุณุคูู. ูุง ููููู ุญูุธ ุงูุชุนุฏููุงุช ุนูู ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ.
        </div>

        <form id="settingsForm">
            <h3>๐จ ุฅุนุฏุงุฏุงุช ุงูุชูุณูู ุงูุจุตุฑู</h3>
            <label for="blinkSpeedInput">ุณุฑุนุฉ ูููุถ ุงูุชูุจูู (ุซุงููุฉ):</label>
            <div class="input-group">
                <input type="number" id="blinkSpeedInput" min="0.1" max="2" step="0.1" required>
                <span>ุซุงููุฉ</span>
            </div>
            
            <label for="highWeightColorInput">ููู ุงูุชุนุจุฆุฉ ุงูุนุงููุฉ (90% ูู ุงูุณุนุฉ):</label>
            <input type="color" id="highWeightColorInput" required>
            
            <label for="extensionColorInput">ููู ูุถุน ุงูุชูุฏูุฏ (ููู ุงูุณุนุฉ ุงูููุฏุฑุฉ):</label>
            <input type="color" id="extensionColorInput" required>

            <h3 style="margin-top: 30px;">๐ข๏ธ ุฅุฏุงุฑุฉ ุงูุฎุฒุงูุงุช ูุงูุณุนุงุช</h3>
            <div id="siloSettingsContainer"></div>
            <button type="button" class="secondary-btn small-btn" onclick="addSiloSetting()" style="width: auto;">โ ุฅุถุงูุฉ ุฎุฒุงู ุฌุฏูุฏ</button>
            <hr>
            
            <button type="submit" id="saveSettingsBtn" style="margin-top: 20px;">๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช (Cloud)</button>
            <p id="settingsMessage" style="color: green; font-weight: bold; display: none; margin-top: 10px;"></p>
            
            <hr style="margin-top: 20px;">
            <h3 style="color: #dc3545;">โ๏ธ ุงูููุทูุฉ ุงูุฎุทุฑุฉ</h3>
            <p style="font-size: 0.85rem; color: #6c757d;">ุญุฐู ุฌููุน ุจูุงูุงุชู ูู ุงูุณุญุงุจุฉ ุจุดูู ููุงุฆู.</p>
            <button type="button" class="reset-btn" onclick="factoryReset()">๐ฅ ุญุฐู ุจูุงูุงุชู ูุฅุนุงุฏุฉ ุถุจุท ุงููุตูุน</button>
        </form>
    </div>
</div>

<div id="historyPage" class="container" style="display:none;">
    <h2>๐ ุงูุฃุฑุดูู ุงูุชุงุฑูุฎู</h2>
    <div style="background:#e8f5e9; padding:10px; margin-bottom:15px; border-radius:5px; border:1px solid #c8e6c9;">
        <strong>๐ ุงููุงุนุฉ ุงูุดุฑููุฉ:</strong> ุฃูุถู ุฅูุชุงุฌ ูุณุฌู ูุงู ุจุชุงุฑูุฎ <span id="bestDateDisplay"></span> ุจูููุฉ <strong id="bestAmountDisplay"></strong> ุทู.
    </div>
    <table id="historyTable">
        <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุฅุฌูุงูู (T)</th><th>ุงูุณุฑุนุฉ (T/h)</th><th>ุฎูุงุฑุงุช</th></tr></thead> 
        <tbody id="historyBody"></tbody>
    </table>
    <button style="margin-top: 20px;" onclick="hideHistory()" class="secondary-btn">๐ ุนูุฏุฉ</button>
</div>

<div id="sessionDetailsModal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 12px;">
        <h3 style="margin-top:0;">ุชูุงุตูู ุงูุฌูุณุฉ</h3>
        <div id="modalAiSummary" class="ai-summary-box"></div> 
        
        <div style="max-height: 300px; overflow-y: auto;">
            <table id="modalRecordsTable">
                <thead>
                    <tr><th>ุงูููุช</th><th>ุงูุฎุฒุงู</th><th>ุงููุฒู</th><th>ุงููุฑู</th></tr> 
                </thead>
                <tbody id="modalRecordsBody"></tbody>
            </table>
        </div>
        <button onclick="document.getElementById('sessionDetailsModal').style.display='none'" class="danger-btn small-btn" style="float: right; margin-top: 15px;">ุฅุบูุงู</button>
        <div style="clear: both;"></div>
    </div>
</div>

<script>
    // ==========================================
    // โ๏ธ ุฅุนุฏุงุฏุงุช Firebase
    // ==========================================
    
    const firebaseConfig = {
        apiKey: "AIzaSyCXeIS89Cd0DKz7BTsIfQDr3Ckb544dR8k",
        authDomain: "siloun.firebaseapp.com",
        databaseURL: "https://siloun-default-rtdb.firebaseio.com",
        projectId: "siloun",
        storageBucket: "siloun.firebasestorage.app",
        messagingSenderId: "111587591132",
        appId: "1:111587591132:web:0b7e481138e8885076c519"
    };

    // ุชููุฆุฉ Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const database = firebase.database();

    // ==========================================
    // โ๏ธ ุงููุชุบูุฑุงุช ูุงูุซูุงุจุช
    // ==========================================
    
    // ๐ ุชุฃูุฏ ุฃู ูุฐุง ูุทุงุจู ุงูุจุฑูุฏ ุงูููุฌูุฏ ูู ููุงุนุฏ ุงูุฃูุงู
    const ADMIN_EMAIL = 'koreanarabione@gmail.com'; 
    const DB_ROOT_PATH = 'molino_app_data/';
    const SETTINGS_PATH = 'settings'; 

    let currentUserId = null;
    let currentUserEmail = null;
    let AppSettings = {}; 
    let currentSessionRecords = []; 
    let lastKnownWeights = {}; 
    let currentAiAnalysis = {}; 
    let authMode = 'login'; 
    
    let currentWeightsChart = null;
    let currentDifferencesChart = null;
    let historyTotalChart = null;
    let historySpeedChart = null;
    
    const DEFAULT_CHART_COLORS = {
        'Good': 'rgba(40, 167, 69, 1)', 
        'Bad': 'rgba(220, 53, 69, 1)', 
    };

    const DEFAULT_SETTINGS = {
        BLINK_SPEED: 1.0, 
        HIGH_WEIGHT_COLOR: '#ffc107', 
        EXTENSION_COLOR: '#dc3545',   
        NORMAL_COLOR: '#28a745',      
        SILOS: [
            { id: 1, name: 'Siloun 1', ratedCapacity: 63.0, maxExtension: 75.0 },
            { id: 2, name: 'Siloun 2', ratedCapacity: 63.0, maxExtension: 75.0 },
            { id: 3, name: 'Siloun 3', ratedCapacity: 63.0, maxExtension: 75.0 },
            { id: 4, name: 'Siloun 4', ratedCapacity: 63.0, maxExtension: 75.0 }
        ],
    };

    // ==========================================
    // ๐ ุฅุฏุงุฑุฉ ุงููุตุงุฏูุฉ (Auth Management)
    // ==========================================

    auth.onAuthStateChanged((user) => {
        hideAllPages();
        if (user) {
            currentUserId = user.uid;
            currentUserEmail = user.email;
            
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('loggedInUser').textContent = user.email;
            
            // ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
            loadInitialData(); 
        } else {
            currentUserId = null;
            currentUserEmail = null;
            document.getElementById('auth-page').style.display = 'flex';
        }
    });

    function toggleAuthMode() {
        const title = document.getElementById('auth-title');
        const button = document.getElementById('authButton');
        const link = document.getElementById('toggleAuth');
        const message = document.getElementById('authMessage');

        if (authMode === 'login') {
            authMode = 'register';
            title.textContent = 'ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ โจ';
            button.textContent = 'ุชุณุฌูู';
            link.textContent = 'ูุฏู ุญุณุงุจ ุจุงููุนู (ุชุณุฌูู ุฏุฎูู)';
        } else {
            authMode = 'login';
            title.textContent = 'ุชุณุฌูู ุงูุฏุฎูู ๐';
            button.textContent = 'ุฏุฎูู';
            link.textContent = 'ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ';
        }
        message.style.display = 'none';
    }

    document.getElementById('authForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passwordInput').value.trim();
        const message = document.getElementById('authMessage');

        message.style.display = 'none';

        if (authMode === 'register') {
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    message.textContent = 'โ ุชู ุงูุชุณุฌูู ุจูุฌุงุญ. ุฌุงุฑู ุงูุฏุฎูู...';
                    message.style.backgroundColor = '#d4edda';
                    message.style.color = '#155724';
                    message.style.display = 'block';
                })
                .catch(error => {
                    message.textContent = `โ ุฎุทุฃ: ${error.message}`;
                    message.style.backgroundColor = '#f8d7da';
                    message.style.color = '#721c24';
                    message.style.display = 'block';
                });
        } else {
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    message.textContent = `โ ุฎุทุฃ: ${error.message}`;
                    message.style.backgroundColor = '#f8d7da';
                    message.style.color = '#721c24';
                    message.style.display = 'block';
                });
        }
    });

    function logout() {
        if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
            auth.signOut();
        }
    }

    // ==========================================
    // โ๏ธ ูุธุงุฆู ุงูุจูุงูุงุช (Firebase Database)
    // ==========================================

    async function loadInitialData() {
        await loadSettings(); // ุชุญููู ุงูุฅุนุฏุงุฏุงุช ุฃููุงู
        await loadUserSessionData(); // ุซู ุจูุงูุงุช ุงูุฌูุณุฉ
        
        updateDateTime();
        updateAllGauges();
        renderRecords();
        performSmartAIAnalysis();
    }

    function loadSettings() {
        // ูุฑุงุกุฉ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ
        return database.ref(DB_ROOT_PATH + SETTINGS_PATH).once('value')
            .then(snapshot => {
                const val = snapshot.val();
                if (val) {
                    AppSettings = { ...DEFAULT_SETTINGS, ...val };
                    // ุชุตุญูุญ ุงููุตูููุงุช ุฅุฐุง ุฌุงุกุช ููุงุฆูุงุช
                    if (val.SILOS && !Array.isArray(val.SILOS)) {
                        AppSettings.SILOS = Object.values(val.SILOS);
                    }
                } else {
                    AppSettings = DEFAULT_SETTINGS;
                }
                
                // ุงูุชุฃูุฏ ูู ุฃู ูู ุฎุฒุงู ูุฏูู ID
                AppSettings.SILOS = AppSettings.SILOS.map((s, i) => ({ ...s, id: s.id || (i + 1) }));
                applySettingsToUI();
            });
    }

    function saveSettings() {
        // ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุคูู
        if (currentUserEmail !== ADMIN_EMAIL) {
            return Promise.reject(new Error("ุบูุฑ ูุตุฑุญ ูู ุจุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ."));
        }

        const settingsToSave = JSON.parse(JSON.stringify(AppSettings));
        delete settingsToSave.NORMAL_COLOR; // ูุง ูุญูุธ ุงูุซุงุจุช
        
        return database.ref(DB_ROOT_PATH + SETTINGS_PATH).set(settingsToSave);
    }

    function loadUserSessionData() {
        if (!currentUserId) return Promise.resolve();
        
        return database.ref(DB_ROOT_PATH + 'sessions/' + currentUserId).once('value')
            .then(snapshot => {
                const stored = snapshot.val();
                currentSessionRecords = stored ? Object.values(stored) : [];
                
                // ุญุณุงุจ ุขุฎุฑ ูุฒู ูุนุฑูู ููู ุฎุฒุงู
                lastKnownWeights = {}; 
                AppSettings.SILOS.forEach(silo => {
                    const recs = currentSessionRecords
                        .filter(r => r.siloun === silo.name)
                        .sort((a,b) => a.id - b.id); 
                    lastKnownWeights[silo.name] = recs.length ? parseFloat(recs[recs.length-1].weight) : 0;
                });
            });
    }

    function saveUserSessionData() {
        if (!currentUserId) return Promise.resolve();
        
        // ุชุญููู ุงููุตูููุฉ ุฅูู ูุงุฆู ุจุงุณุชุฎุฏุงู ID ูููุชุงุญ
        const sessionObject = currentSessionRecords.reduce((obj, rec) => {
            obj[rec.id] = rec;
            return obj;
        }, {});
        
        return database.ref(DB_ROOT_PATH + 'sessions/' + currentUserId).set(sessionObject);
    }
    
    function loadUserHistory() {
        if (!currentUserId) return Promise.resolve([]);
        return database.ref(DB_ROOT_PATH + 'history/' + currentUserId).once('value')
            .then(snapshot => {
                 const stored = snapshot.val();
                 return stored ? Object.values(stored) : [];
            });
    }

    function saveUserHistory(historyData) {
        if (!currentUserId) return Promise.resolve();
        
        const historyObject = historyData.reduce((obj, rec) => {
            obj[new Date(rec.date).getTime()] = rec; 
            return obj;
        }, {});

        return database.ref(DB_ROOT_PATH + 'history/' + currentUserId).set(historyObject);
    }

    // ==========================================
    // ๐ฅ๏ธ ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุงูููุทู
    // ==========================================

    function hideAllPages() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('historyPage').style.display = 'none';
        document.getElementById('sessionDetailsModal').style.display = 'none';
        document.getElementById('chartsModal').style.display = 'none';
        document.getElementById('settingsModal').style.display = 'none'; 
    }

    function applySettingsToUI() {
        document.documentElement.style.setProperty('--blink-speed', `${AppSettings.BLINK_SPEED}s`);
        
        const maxOverallExtension = AppSettings.SILOS.reduce((max, s) => Math.max(max, s.maxExtension), 0);
        const maxWeightDisplay = document.getElementById('maxWeightDisplay');
        if (maxWeightDisplay) {
            maxWeightDisplay.textContent = `Max ${maxOverallExtension.toFixed(1)}T`;
        }
        
        updateSiloDropdown();
        setupGauges();
        updateAllGauges();
    }
    
    function updateSiloDropdown() {
        const select = document.getElementById('silounSelect');
        if (select) {
            select.innerHTML = AppSettings.SILOS.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            
            select.onchange = () => {
                const selectedSiloName = select.value;
                const selectedSilo = AppSettings.SILOS.find(s => s.name === selectedSiloName);
                if (selectedSilo) {
                     document.getElementById('weightInput').max = selectedSilo.maxExtension;
                     document.getElementById('maxWeightDisplay').textContent = `Max ${selectedSilo.maxExtension.toFixed(1)}T`;
                }
            };
            if(AppSettings.SILOS.length > 0) {
                 // Trigger change to set initial max values
                 select.dispatchEvent(new Event('change'));
            }
        }
    }

    function setupGauges() {
        document.getElementById('gauges').innerHTML = AppSettings.SILOS.map(silo => {
            const RATED_CAPACITY = silo.ratedCapacity;
            const MAX_EXTENSION = silo.maxExtension;
            const siloName = silo.name;
            const id = siloName.replace(/\s/g,''); // ุฅุฒุงูุฉ ุงููุณุงูุงุช ููู ID
            
            return `
                <div class="gauge-container">
                    <div class="gauge-labels">
                        <strong>${siloName}</strong>
                        <strong style="font-family:sans-serif;"><span id="w-${id}">0.00</span> T</strong>
                    </div>
                    <div class="gauge-wrapper">
                        <div class="gauge-main"><div id="bar-m-${id}" class="fill-bar" style="background:${AppSettings.NORMAL_COLOR};"></div></div>
                        <div class="gauge-extension"><div id="bar-e-${id}" class="fill-bar" style="background:${AppSettings.EXTENSION_COLOR};"></div></div>
                    </div>
                    <div class="gauge-sub-labels"><span>0</span><span style="margin-right:-15%">${RATED_CAPACITY.toFixed(1)}</span><span>${MAX_EXTENSION.toFixed(1)}</span></div>
                </div>
            `;
        }).join('');
    }

    function updateGauge(siloName, weight) {
        const siloSettings = AppSettings.SILOS.find(s => s.name === siloName);
        if (!siloSettings) return;

        const RATED_CAPACITY = siloSettings.ratedCapacity;
        const MAX_EXTENSION = siloSettings.maxExtension;
        const id = siloName.replace(/\s/g,'');
        const w = parseFloat(weight); 

        const wDisplay = document.getElementById(`w-${id}`);
        const mBar = document.getElementById(`bar-m-${id}`);
        const eBar = document.getElementById(`bar-e-${id}`);
        
        if (!wDisplay || !mBar || !eBar) return; 

        wDisplay.textContent = w.toFixed(2);

        if (w <= RATED_CAPACITY) {
            mBar.style.width = `${(w/RATED_CAPACITY)*100}%`;
            eBar.style.width = '0%';
            mBar.style.backgroundColor = w >= (RATED_CAPACITY * 0.9) ? AppSettings.HIGH_WEIGHT_COLOR : AppSettings.NORMAL_COLOR;
            eBar.textContent = "";
            eBar.classList.remove('blinking');
        } else {
            mBar.style.width = '100%';
            mBar.style.backgroundColor = AppSettings.HIGH_WEIGHT_COLOR; 
            
            const extensionRange = MAX_EXTENSION - RATED_CAPACITY;
            const extendedWeight = w - RATED_CAPACITY;
            const extP = (extendedWeight / extensionRange) * 100;
            
            eBar.style.width = `${Math.min(extP, 100)}%`;
            eBar.textContent = "EXT";
            eBar.style.backgroundColor = AppSettings.EXTENSION_COLOR;
            
            if (w >= MAX_EXTENSION) eBar.classList.add('blinking');
            else eBar.classList.remove('blinking');
        }
    }

    function updateAllGauges() { 
        AppSettings.SILOS.map(s => s.name).forEach(s => updateGauge(s, lastKnownWeights[s]||0)); 
    }

    // --- ูุนุงูุฌุฉ ุฅุฏุฎุงู ุงูุจูุงูุงุช ---
    document.getElementById('entryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const s = document.getElementById('silounSelect').value;
        const w = parseFloat(document.getElementById('weightInput').value);
        const dt = document.getElementById('dateTimeInput').value;
        const newTime = new Date(dt).getTime();
        
        const siloSettings = AppSettings.SILOS.find(sl => sl.name === s);
        if (w > siloSettings.maxExtension) return alert(`ุฎุทุฃ: ุงููุฒู ูุชุฌุงูุฒ ${siloSettings.maxExtension.toFixed(1)} ุทู ููุฐุง ุงูุฎุฒุงู!`);

        // ุงูุชุญูู ูู ุงูุชุฑุชูุจ ุงูุฒููู
        if (currentSessionRecords.length > 0) {
            const sortedRecords = [...currentSessionRecords].sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
            const lastRecordedTime = new Date(sortedRecords[0].dateTime).getTime();
            if (newTime < lastRecordedTime) {
                alert(`ุฎุทุฃ ุฒููู: ูุง ูููู ุฅุฏุฎุงู ูุฑุงุกุฉ ุณุงุจูุฉ ูููุช ุขุฎุฑ ุณุฌู.`);
                return; 
            }
        }
        
        const prev = lastKnownWeights[s] || 0;
        let diff = 'ุจุฏุงูุฉ';
        // ุฅุฐุง ูุงู ููุงู ุณุฌู ุณุงุจู ูููุณ ุงูุฎุฒุงู ูู ุงูุฌูุณุฉ
        if (currentSessionRecords.some(r => r.siloun === s) || prev > 0) {
             diff = (w - prev).toFixed(2);
        }

        currentSessionRecords.push({ id: Date.now(), dateTime: dt, siloun: s, weight: w.toFixed(2), difference: diff });
        lastKnownWeights[s] = w;
        
        await saveUserSessionData(); // ุญูุธ ูู ุงูุณุญุงุจุฉ
        
        renderRecords();
        updateGauge(s, w);
        performSmartAIAnalysis(); 
        
        document.getElementById('weightInput').value = '';
        updateDateTime();
    });

    function renderRecords() {
        const tb = document.getElementById('recordsBody');
        tb.innerHTML = '';
        [...currentSessionRecords].reverse().forEach(r => {
            const diffVal = parseFloat(r.difference);
            const diffColor = diffVal > 0 ? 'green' : (diffVal < 0 ? 'red' : 'inherit');
            tb.innerHTML += `<tr>
                <td>${formatDateTimeEnglish(r.dateTime)}</td>
                <td>${r.siloun}</td>
                <td>${r.weight}</td>
                <td style="color:${diffColor}">${r.difference}</td>
                <td><button class="danger-btn small-btn" onclick="deleteRecord(${r.id})">โ</button></td>
            </tr>`;
        });
    }

    async function deleteRecord(id) {
        if(!confirm('ุญุฐู ุงูุณุฌูุ')) return;
        
        const idx = currentSessionRecords.findIndex(r=>r.id===id);
        if(idx===-1) return;
        const silo = currentSessionRecords[idx].siloun;
        currentSessionRecords.splice(idx,1);
        
        // ุฅุนุงุฏุฉ ุญุณุงุจ ุงููุฑููุงุช ููุฐุง ุงูุฎุฒุงู
        let siloRecs = currentSessionRecords
            .filter(r=>r.siloun===silo)
            .sort((a,b)=>a.id - b.id); 

        siloRecs.forEach((r,i) => {
            if(i === 0) r.difference = 'ุจุฏุงูุฉ'; // ุฃู ูุนุชูุฏ ุนูู ุขุฎุฑ ุฌูุณุฉ (ุบูุฑ ูุทุจู ููุง ููุจุณุงุทุฉ)
            else {
                const prevWeight = parseFloat(siloRecs[i - 1].weight);
                r.difference = (parseFloat(r.weight) - prevWeight).toFixed(2);
            }
        });
        
        lastKnownWeights[silo] = siloRecs.length ? parseFloat(siloRecs[siloRecs.length-1].weight) : 0;
        
        await saveUserSessionData();
        renderRecords();
        updateAllGauges();
        performSmartAIAnalysis();
    }

    // --- ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุชุญููู ---
    function performSmartAIAnalysis() {
        const insightsList = document.getElementById('aiInsightsList');
        const aiSpeed = document.getElementById('aiSpeed');
        const aiTotal = document.getElementById('aiTotal');
        const aiBestDay = document.getElementById('aiBestDay');
        const liveStatus = document.getElementById('liveStatus');
        const compBar = document.getElementById('compBar');
        const compText = document.getElementById('compText');
        const compMessage = document.getElementById('compMessage');

        if (currentSessionRecords.length === 0) {
            aiSpeed.textContent = "0.0";
            aiTotal.textContent = "0.00";
            liveStatus.textContent = "ุจุฏุงูุฉ ๐ค";
            liveStatus.style.background = "#999";
            liveStatus.style.color = "white";
            insightsList.innerHTML = '<li>ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ูุจุฏุก ุงูุชุญููู...</li>';
            compBar.style.width = '0%';
            compText.textContent = '0%';
            return;
        }

        insightsList.innerHTML = '';
        let insights = [];
        let totalCurrent = 0;
        
        currentSessionRecords.forEach(r => {
            const v = parseFloat(r.difference);
            if(v > 0) totalCurrent += v; 
        });
        aiTotal.textContent = totalCurrent.toFixed(2);

        // ุชุญููู ุงูุฃุฑุดูู ููููุงุฑูุฉ
        loadUserHistory().then(history => {
            let maxHistTotal = 0;
            let bestDateStr = 'ูุง ููุฌุฏ';
            let histTotals = [];
            
            history.forEach(h => {
                const t = parseFloat(h.total);
                histTotals.push(t);
                if(t > maxHistTotal) {
                    maxHistTotal = t;
                    bestDateStr = formatDateOnly(h.date); 
                }
            });
            aiBestDay.textContent = maxHistTotal > 0 ? `${maxHistTotal} (${bestDateStr})` : '-';
            
            // ุดุฑูุท ุงูุชูุฏู
            if (histTotals.length > 0) {
                const avgHist = histTotals.reduce((a,b)=>a+b,0) / histTotals.length;
                const ratio = (totalCurrent / (avgHist || 1)) * 100;
                compBar.style.width = `${Math.min(ratio, 100)}%`;
                compText.textContent = `${ratio.toFixed(0)}%`;
                if(ratio > 100) { compBar.style.backgroundColor = '#28a745'; compMessage.textContent = 'ููุชุงุฒ! ุฃุนูู ูู ุงููุนุฏู.'; }
                else if(ratio > 50) { compBar.style.backgroundColor = '#17a2b8'; compMessage.textContent = 'ุฃุฏุงุก ุฌูุฏ.'; }
                else { compBar.style.backgroundColor = '#ffc107'; compMessage.textContent = 'ุฃูู ูู ุงููุนุฏู.'; }
            }
        });

        // ุญุณุงุจ ุงูุณุฑุนุฉ ูุงูุชููุนุงุช
        if (currentSessionRecords.length > 1) {
            const sorted = [...currentSessionRecords].sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
            const startTime = new Date(sorted[0].dateTime);
            const endTime = new Date(sorted[sorted.length-1].dateTime);
            const durationHrs = (endTime - startTime) / 3600000; 
            
            if (durationHrs > 0.1) { 
                const speed = totalCurrent / durationHrs;
                aiSpeed.textContent = speed.toFixed(1);
                liveStatus.textContent = "ูุนูู โก";
                liveStatus.style.background = "#4caf50";
                liveStatus.style.color = "white";
                
                currentAiAnalysis.speed = speed.toFixed(1);
                currentAiAnalysis.duration = durationHrs.toFixed(2);
            }

            // ูุญุต ุขุฎุฑ ุชุณุฌูููู ููุชููุน
            const lastRec = sorted[sorted.length-1];
            const prevRec = sorted[sorted.length-2];
            
            if (lastRec.siloun === prevRec.siloun) {
                const silo = AppSettings.SILOS.find(s => s.name === lastRec.siloun);
                if (silo) {
                    const timeDiff = (new Date(lastRec.dateTime) - new Date(prevRec.dateTime)) / 3600000;
                    const wDiff = parseFloat(lastRec.weight) - parseFloat(prevRec.weight);
                    
                    if (timeDiff > 0 && wDiff > 0.5) {
                        const rate = wDiff / timeDiff; // ุทู/ุณุงุนุฉ ููุฎุฒุงู ุงููุญุฏุฏ
                        const remaining = silo.ratedCapacity - parseFloat(lastRec.weight);
                        if (remaining > 0 && rate > 0) {
                            const hrsLeft = remaining / rate;
                            const finishTime = new Date(endTime.getTime() + (hrsLeft * 3600000));
                            insights.push(`โฑ๏ธ **ุชููุน:** ุณููุชูุฆ ${silo.name} ุญูุงูู ุงูุณุงุนุฉ ${finishTime.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}`);
                        }
                    }
                }
            }
            
            // ุชูุจูู ุงูุชููู
            const minsSince = (new Date() - endTime) / 60000;
            if (minsSince > 30) {
                insights.push(`โ๏ธ **ุชูุจูู:** ุงูุทุญู ูุชููู ููุฐ ${minsSince.toFixed(0)} ุฏูููุฉ.`);
                liveStatus.textContent = "ูุชููู ๐ค";
                liveStatus.style.background = "#dc3545"; 
            }
        }

        // ุชุญุฐูุฑุงุช ุงูุณุนุงุช
        AppSettings.SILOS.forEach(silo => {
            const w = lastKnownWeights[silo.name] || 0;
            if (w >= silo.maxExtension) insights.push(`๐ **ุฎุทุฑ:** ${silo.name} ููุชูุฆ ุชูุงูุงู (${w}T)!`);
            else if (w > silo.ratedCapacity) insights.push(`๐จ **ุชุญุฐูุฑ:** ${silo.name} ูู ูุถุน ุงูุชูุฏูุฏ.`);
        });

        currentAiAnalysis.total = totalCurrent.toFixed(2);
        currentAiAnalysis.insights = insights.map(i => i.replace(/\*\*(.*?)\*\*/g, '$1'));

        if (insights.length === 0) insights.push("โ ุงููุธุงู ูุณุชูุฑ.");
        insightsList.innerHTML = insights.map(i => `<li>${i.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</li>`).join('');
    }

    // ==========================================
    // โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู (Settings UI)
    // ==========================================

    function showSettingsModal() {
        document.getElementById('settingsModal').style.display = 'block';
        document.getElementById('blinkSpeedInput').value = AppSettings.BLINK_SPEED;
        document.getElementById('highWeightColorInput').value = AppSettings.HIGH_WEIGHT_COLOR;
        document.getElementById('extensionColorInput').value = AppSettings.EXTENSION_COLOR;
        
        renderSiloSettings();

        // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุคูู
        const saveBtn = document.getElementById('saveSettingsBtn');
        const warning = document.getElementById('admin-access-warning');
        
        if (currentUserEmail !== ADMIN_EMAIL) {
            saveBtn.disabled = true;
            saveBtn.style.backgroundColor = '#ccc';
            saveBtn.textContent = '๐พ ุญูุธ (ูุชุงุญ ูููุณุคูู ููุท)';
            warning.style.display = 'block';
        } else {
            saveBtn.disabled = false;
            saveBtn.style.backgroundColor = '#28a745';
            saveBtn.textContent = '๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช (Cloud)';
            warning.style.display = 'none';
        }
    }

    function hideSettingsModal() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    function renderSiloSettings() {
        const container = document.getElementById('siloSettingsContainer');
        container.innerHTML = AppSettings.SILOS.map((silo, index) => `
            <div class="silo-settings-row">
                <div class="silo-name-input">
                    <label>ุงูุฎุฒุงู ${index+1}:</label>
                    <input type="text" value="${silo.name}" id="silo-name-${silo.id}" ${currentUserEmail !== ADMIN_EMAIL ? 'disabled' : ''}>
                </div>
                <div class="silo-capacity-input">
                    <label>ุงูุณุนุฉ (T):</label>
                    <input type="number" value="${silo.ratedCapacity}" id="silo-rated-${silo.id}" ${currentUserEmail !== ADMIN_EMAIL ? 'disabled' : ''}>
                </div>
                <div class="silo-capacity-input">
                    <label>Max (T):</label>
                    <input type="number" value="${silo.maxExtension}" id="silo-max-${silo.id}" ${currentUserEmail !== ADMIN_EMAIL ? 'disabled' : ''}>
                </div>
                ${currentUserEmail === ADMIN_EMAIL ? `<button class="danger-btn small-btn" type="button" onclick="removeSiloSetting(${silo.id})">โ</button>` : ''}
            </div>
        `).join('');
    }

    function addSiloSetting() {
        if (currentUserEmail !== ADMIN_EMAIL) return alert("ูููุณุคูู ููุท.");
        const newId = AppSettings.SILOS.reduce((max, s) => Math.max(max, s.id), 0) + 1;
        AppSettings.SILOS.push({ id: newId, name: `New Silo ${newId}`, ratedCapacity: 50, maxExtension: 60 });
        renderSiloSettings();
    }

    function removeSiloSetting(id) {
        if (AppSettings.SILOS.length <= 1) return alert("ูุฌุจ ุฅุจูุงุก ุฎุฒุงู ูุงุญุฏ.");
        AppSettings.SILOS = AppSettings.SILOS.filter(s => s.id !== id);
        renderSiloSettings();
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // ุชุฌููุน ุงูููู ุงูุฌุฏูุฏุฉ
        const newSilos = [];
        AppSettings.SILOS.forEach(silo => {
            newSilos.push({
                id: silo.id,
                name: document.getElementById(`silo-name-${silo.id}`).value,
                ratedCapacity: parseFloat(document.getElementById(`silo-rated-${silo.id}`).value),
                maxExtension: parseFloat(document.getElementById(`silo-max-${silo.id}`).value)
            });
        });

        AppSettings.BLINK_SPEED = parseFloat(document.getElementById('blinkSpeedInput').value);
        AppSettings.HIGH_WEIGHT_COLOR = document.getElementById('highWeightColorInput').value;
        AppSettings.EXTENSION_COLOR = document.getElementById('extensionColorInput').value;
        AppSettings.SILOS = newSilos;

        const msg = document.getElementById('settingsMessage');
        try {
            await saveSettings();
            msg.textContent = "โ ุชู ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ูู ุงูุณุญุงุจุฉ ุจูุฌุงุญ!";
            msg.style.color = "green";
            msg.style.display = "block";
            applySettingsToUI();
            setTimeout(() => { hideSettingsModal(); msg.style.display="none"; }, 2000);
        } catch (err) {
            msg.textContent = `โ ุฎุทุฃ: ${err.message}`;
            msg.style.color = "red";
            msg.style.display = "block";
        }
    });

    // ==========================================
    // ๐ ุงูุฃุฑุดูู ูุฅููุงุก ุงูุนูู
    // ==========================================

    async function endWork() {
        if (currentSessionRecords.length === 0) return alert('ูุง ููุฌุฏ ุจูุงูุงุช.');
        if (!confirm('ุฅููุงุก ุงูุฌูุณุฉ ูุญูุธูุงุ')) return;

        performSmartAIAnalysis(); // ุชุฃูุฏ ูู ุชุญุฏูุซ ุงูุชุญููู

        const h = await loadUserHistory();
        h.push({
            date: new Date().toISOString(),
            total: currentAiAnalysis.total,
            speed: currentAiAnalysis.speed || 0,
            aiReport: currentAiAnalysis.insights,
            records: currentSessionRecords
        });

        await saveUserHistory(h);
        
        // ูุณุญ ุงูุฌูุณุฉ ุงูุญุงููุฉ ูู ุงูุณุญุงุจุฉ
        await database.ref(DB_ROOT_PATH + 'sessions/' + currentUserId).remove();
        
        alert("โ ุชู ุงูุญูุธ ุจูุฌุงุญ!");
        location.reload();
    }

    async function viewHistory() {
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('historyPage').style.display = 'block';
        
        const h = await loadUserHistory();
        const tb = document.getElementById('historyBody');
        tb.innerHTML = '';
        
        [...h].reverse().forEach(x => {
            const dateStr = new Date(x.date).toLocaleDateString('en-GB');
            // ุชุญููู ุงููุงุฆู ููุต ูุชูุฑูุฑู ููุฏุงูุฉ
            const jsonStr = encodeURIComponent(JSON.stringify(x));
            
            tb.innerHTML += `<tr>
                <td>${dateStr}</td>
                <td>${x.total}</td>
                <td>${x.speed || '-'}</td>
                <td><button class="secondary-btn small-btn" onclick="showHistoryDetails('${jsonStr}')">ุนุฑุถ</button></td>
            </tr>`;
        });
    }

    function showHistoryDetails(encodedJson) {
        const x = JSON.parse(decodeURIComponent(encodedJson));
        const tb = document.getElementById('modalRecordsBody');
        tb.innerHTML = '';
        
        const aiSummary = document.getElementById('modalAiSummary');
        let html = `<p><strong>ุงูุฅุฌูุงูู:</strong> ${x.total} T | <strong>ุงูุณุฑุนุฉ:</strong> ${x.speed} T/h</p>`;
        if(x.aiReport) html += `<ul>${x.aiReport.map(i=>`<li>${i}</li>`).join('')}</ul>`;
        aiSummary.innerHTML = html;

        x.records.forEach(r => {
             tb.innerHTML += `<tr><td>${formatDateTimeEnglish(r.dateTime)}</td><td>${r.siloun}</td><td>${r.weight}</td><td>${r.difference}</td></tr>`;
        });
        document.getElementById('sessionDetailsModal').style.display = 'block';
    }

    function hideHistory() {
        document.getElementById('historyPage').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
    }

    async function factoryReset() {
        if(!confirm("โ๏ธ ุชุญุฐูุฑ: ุณูุชู ุญุฐู ุฌููุน ุจูุงูุงุชู (ุงูุฌูุณุงุช ูุงูุฃุฑุดูู) ูู ุงูุณุญุงุจุฉ. ูู ุฃูุช ูุชุฃูุฏุ")) return;
        
        await database.ref(DB_ROOT_PATH + 'sessions/' + currentUserId).remove();
        await database.ref(DB_ROOT_PATH + 'history/' + currentUserId).remove();
        
        alert("ุชู ุงูุญุฐู.");
        location.reload();
    }

    // ==========================================
    // ๐ ุงูุฑุณูู ุงูุจูุงููุฉ (Charts)
    // ==========================================

    function showChartsModal() {
        document.getElementById('chartsModal').style.display = 'block';
        renderAllCharts();
    }
    function hideChartsModal() {
        document.getElementById('chartsModal').style.display = 'none';
        destroyAllCharts();
    }
    
    function destroyAllCharts() {
        if (currentWeightsChart) currentWeightsChart.destroy();
        if (currentDifferencesChart) currentDifferencesChart.destroy();
        if (historyTotalChart) historyTotalChart.destroy();
        if (historySpeedChart) historySpeedChart.destroy();
    }

    async function renderAllCharts() {
        destroyAllCharts();
        
        // 1. ุงูุฃูุฒุงู ุงูุญุงููุฉ
        const labels = AppSettings.SILOS.map(s=>s.name);
        const dataW = labels.map(n => lastKnownWeights[n] || 0);
        currentWeightsChart = new Chart(document.getElementById('currentWeightsChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'ุงููุฒู ุงูุญุงูู', data: dataW, backgroundColor: 'rgba(54, 162, 235, 0.6)' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 2. ุงููุฑููุงุช
        const recs = [...currentSessionRecords];
        const labelsDiff = recs.map(r => r.dateTime.split('T')[1]);
        const dataDiff = recs.map(r => parseFloat(r.difference));
        currentDifferencesChart = new Chart(document.getElementById('currentDifferencesChart'), {
            type: 'line',
            data: {
                labels: labelsDiff,
                datasets: [{ label: 'ุงููุฑู', data: dataDiff, borderColor: '#ff6384', fill:false }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 3 & 4 ุงูุฃุฑุดูู
        const hist = await loadUserHistory();
        const hLabels = hist.map(h => new Date(h.date).toLocaleDateString('en-GB'));
        const hTotal = hist.map(h => parseFloat(h.total));
        const hSpeed = hist.map(h => parseFloat(h.speed));

        historyTotalChart = new Chart(document.getElementById('historyTotalChart'), {
            type: 'line',
            data: { labels: hLabels, datasets: [{ label: 'ุงูุฅูุชุงุฌ', data: hTotal, borderColor: '#28a745', tension: 0.1 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        historySpeedChart = new Chart(document.getElementById('historySpeedChart'), {
            type: 'bar',
            data: { labels: hLabels, datasets: [{ label: 'ุงูุณุฑุนุฉ', data: hSpeed, backgroundColor: '#17a2b8' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // Helpers
    function formatDateTimeEnglish(iso) {
        if(!iso) return '-';
        return new Date(iso).toLocaleString('en-GB', {hour12:false}).replace(',','');
    }
    function formatDateOnly(iso) {
        if(!iso) return '-';
        return new Date(iso).toLocaleDateString('en-GB');
    }
    function updateDateTime() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        document.getElementById('dateTimeInput').value = new Date(now.getTime() - offset).toISOString().slice(0, 16);
    }
    function exportData() {
        // ุชุตุฏูุฑ ุจุณูุท ููุจูุงูุงุช ุงููุญููุฉ ุงูุญุงููุฉ
        const d = { session: currentSessionRecords, settings: AppSettings };
        const blob = new Blob([JSON.stringify(d)], {type:"application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "backup.json";
        a.click();
    }
    function importData(e) { alert("ุงูุงุณุชูุฑุงุฏ ุงูุณุญุงุจู ุบูุฑ ููุนู ูู ูุฐู ุงููุณุฎุฉ ููุญูุงุธ ุนูู ุณูุงูุฉ ุงูุจูุงูุงุช."); }

</script>
</body>
</html>



<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molino AI Cloud - النظام الذكي</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* مؤشرات التحميل */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* شريط التمديد */
        .gauge-bar { transition: width 1s ease-in-out; }
        .blinking { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <div id="auth-view" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Molino Cloud <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">AI V6</span></h1>
            <p class="text-gray-500 mb-6">تسجيل الدخول للنظام المركزي</p>
            
            <form id="authForm" class="space-y-4">
                <input type="email" id="emailInput" placeholder="البريد الإلكتروني" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-right">
                <input type="password" id="passwordInput" placeholder="كلمة المرور" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-right">
                <div id="authMessage" class="hidden p-2 rounded text-sm font-bold"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">دخول آمن</button>
            </form>
            <p class="mt-4 text-sm text-gray-500 cursor-pointer hover:text-blue-600" onclick="toggleAuthMode()">ليس لديك حساب؟ إنشاء حساب جديد</p>
        </div>
    </div>

    <div id="app-view" class="hidden">
        
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-industry text-blue-600 text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 leading-none">Molino AI</h1>
                        <span class="text-xs text-gray-500" id="userEmailDisplay">جاري التحميل...</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            
            <nav class="flex overflow-x-auto bg-white border-t border-slate-100 no-scrollbar">
                <button onclick="switchTab('dashboard')" class="tab-btn active flex-1 py-3 px-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition" id="tab-dashboard">
                    <i class="fa-solid fa-gauge ml-1"></i> التحكم
                </button>
                <button onclick="switchTab('ai')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500 transition" id="tab-ai">
                    <i class="fa-solid fa-robot ml-1"></i> المساعد الذكي
                </button>
                <button onclick="switchTab('history')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500 transition" id="tab-history">
                    <i class="fa-solid fa-clock-rotate-left ml-1"></i> الأرشيف
                </button>
                <button onclick="switchTab('settings')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500 transition" id="tab-settings">
                    <i class="fa-solid fa-gear ml-1"></i> الإعدادات
                </button>
            </nav>
        </header>

        <main class="max-w-7xl mx-auto p-4 pb-20">

            <div id="view-dashboard" class="tab-content active space-y-6">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-blue-500"></i> تسجيل قراءة جديدة</h2>
                    <form id="entryForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">الخزان</label>
                            <select id="silounSelect" class="w-full p-2 border rounded bg-slate-50"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">الوزن الحالي (T)</label>
                            <input type="number" id="weightInput" step="0.01" class="w-full p-2 border rounded bg-slate-50 text-left" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">التوقيت</label>
                            <input type="datetime-local" id="dateTimeInput" class="w-full p-2 border rounded bg-slate-50">
                        </div>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition h-[42px]">
                            <i class="fa-solid fa-check"></i> تسجيل
                        </button>
                    </form>
                </div>

                <div id="gauges-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold">سجل الجلسة الحالية</h3>
                        <span id="session-counter" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0 قراءات</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3">الوقت</th>
                                    <th class="p-3">الخزان</th>
                                    <th class="p-3">الوزن</th>
                                    <th class="p-3">الفرق</th>
                                    <th class="p-3">إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="recordsBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="endWork()" class="bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 transition">
                        <i class="fa-solid fa-stop"></i> إنهاء الجلسة والحفظ
                    </button>
                    <button onclick="showCharts()" class="bg-slate-700 hover:bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg transition">
                        <i class="fa-solid fa-chart-line"></i> الرسوم البيانية
                    </button>
                </div>
            </div>

            <div id="view-ai" class="tab-content space-y-6">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-32 h-32 bg-white opacity-10 rounded-full -translate-x-10 -translate-y-10"></div>
                    <h2 class="text-2xl font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-brain"></i> تحليل الإنتاج الذكي</h2>
                    <p class="text-indigo-100 mb-6 text-sm">يقوم Gemini بتحليل بيانات الجلسة الحالية (السرعة، الاستهلاك، التوقعات) ويعطيك تقريراً فنياً.</p>
                    
                    <button onclick="analyzeCurrentSession()" id="analyzeBtn" class="bg-white text-indigo-700 hover:bg-indigo-50 font-bold py-2 px-6 rounded-full shadow-md transition flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> تحليل الجلسة الآن
                    </button>

                    <div id="ai-analysis-result" class="mt-6 bg-white/10 backdrop-blur-sm rounded-xl p-4 text-sm leading-relaxed hidden border border-white/20"></div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 h-[500px] flex flex-col">
                    <div class="p-4 border-b bg-slate-50 font-bold text-gray-700">
                        <i class="fa-solid fa-comments text-blue-500"></i> محادثة مع المساعد التقني
                    </div>
                    
                    <div id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">
                        <div class="flex justify-start">
                            <div class="bg-white border border-slate-200 text-slate-600 p-3 rounded-2xl rounded-tr-none shadow-sm max-w-[85%] text-sm">
                                مرحباً بك! أنا مساعدك الذكي في نظام Molino. يمكنك سؤالي عن صيانة الخزانات، حساب الكفاءة، أو تقييم أي جدول عمل.
                            </div>
                        </div>
                    </div>

                    <div class="p-3 border-t bg-white">
                        <div id="chat-loader" class="h-1 bg-blue-100 w-full mb-2 overflow-hidden rounded-full hidden">
                            <div class="h-full bg-blue-500 animate-pulse w-1/2 mx-auto rounded-full"></div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chatInput" placeholder="اكتب سؤالك هنا..." class="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50" onkeypress="if(event.key === 'Enter') handleChat()">
                            <button onclick="handleChat()" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition w-12 flex items-center justify-center">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-history" class="tab-content">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold">سجل العمليات السابقة</h3>
                        <button onclick="loadUserHistory()" class="text-blue-500 text-sm hover:underline">تحديث</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3">التاريخ</th>
                                    <th class="p-3">الإجمالي (T)</th>
                                    <th class="p-3">السرعة (T/h)</th>
                                    <th class="p-3">تفاصيل</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="tab-content space-y-6">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                    <h3 class="font-bold text-lg mb-4 text-slate-700">إعدادات الخزانات (المسؤول)</h3>
                    <div id="admin-warning" class="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm hidden">
                        <i class="fa-solid fa-lock"></i> للقراءة فقط: أنت لست المسؤول.
                    </div>
                    <form id="settingsForm" class="space-y-4">
                        <div id="siloSettingsContainer" class="space-y-3"></div>
                        <button type="button" onclick="addSiloField()" class="text-blue-600 text-sm hover:underline">+ إضافة خزان</button>
                        <hr>
                        <button type="submit" id="saveSettingsBtn" class="bg-slate-800 text-white py-2 px-6 rounded-lg hover:bg-slate-900 transition">حفظ التغييرات</button>
                    </form>
                </div>
                
                <div class="bg-red-50 rounded-xl p-6 border border-red-100">
                    <h3 class="font-bold text-red-700 mb-2">منطقة الخطر</h3>
                    <p class="text-sm text-red-600 mb-4">حذف جميع البيانات من السحابة. لا يمكن التراجع عن هذا الإجراء.</p>
                    <button onclick="factoryReset()" class="bg-white border border-red-300 text-red-600 hover:bg-red-600 hover:text-white py-2 px-4 rounded transition text-sm">إعادة ضبط المصنع</button>
                </div>
            </div>

        </main>
    </div>

    <div id="chartsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative">
            <button onclick="document.getElementById('chartsModal').classList.add('hidden')" class="absolute top-4 left-4 text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-xl font-bold mb-6">التحليل البياني</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-50 p-4 rounded-xl h-64"><canvas id="chartWeights"></canvas></div>
                <div class="bg-slate-50 p-4 rounded-xl h-64"><canvas id="chartDiff"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. إعدادات Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCXeIS89Cd0DKz7BTsIfQDr3Ckb544dR8k",
            authDomain: "siloun.firebaseapp.com",
            databaseURL: "https://siloun-default-rtdb.firebaseio.com",
            projectId: "siloun",
            storageBucket: "siloun.firebasestorage.app",
            messagingSenderId: "111587591132",
            appId: "1:111587591132:web:0b7e481138e8885076c519"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- 2. إعدادات Gemini AI ---
        // ** تم الإصلاح هنا: تم وضع مفتاح Gemini API الذي أرسلته **
        const GEMINI_API_KEY = "AIzaSyAMvr70Ijt5ueZ8gmropQ_xq0wouo5E75Y"; 
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        // --- 3. المتغيرات العامة ---
        const ADMIN_EMAIL = 'koreanarabione@gmail.com';
        let currentUser = null;
        let appSettings = { 
            SILOS: [
                { id: 1, name: 'Siloun 1', rated: 63, max: 75 },
                { id: 2, name: 'Siloun 2', rated: 63, max: 75 },
                { id: 3, name: 'Siloun 3', rated: 63, max: 75 },
                { id: 4, name: 'Siloun 4', rated: 63, max: 75 }
            ],
            colors: { high: '#f59e0b', ext: '#ef4444', normal: '#10b981' }
        };
        let currentSession = [];
        let charts = {};

        // --- 4. إدارة التبويبات ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                el.classList.add('text-gray-500');
            });
            
            document.getElementById(`view-${tabId}`).classList.add('active');
            const btn = document.getElementById(`tab-${tabId}`);
            btn.classList.remove('text-gray-500');
            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            
            // تحميل الأرشيف عند التبديل
            if (tabId === 'history' && currentUser) {
                loadUserHistory();
            }
            // إعادة عرض الإعدادات
            if (tabId === 'settings' && currentUser) {
                renderSiloSettingsInputs();
            }
        }

        // --- 5. المصادقة ---
        let isLoginMode = true;
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = user.email;
                initializeApp();
            } else {
                currentUser = null;
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.querySelector('#auth-view h1').innerHTML = isLoginMode ? 'Molino Cloud <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">AI V6</span>' : 'إنشاء حساب جديد';
            document.querySelector('#auth-view button').textContent = isLoginMode ? 'دخول آمن' : 'تسجيل حساب';
            document.querySelector('#auth-view p.cursor-pointer').textContent = isLoginMode ? 'ليس لديك حساب؟ إنشاء حساب جديد' : 'لديك حساب بالفعل؟ دخول';
        }

        document.getElementById('authForm').addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            const msg = document.getElementById('authMessage');
            
            msg.textContent = 'جاري الاتصال...';
            msg.className = 'p-2 rounded text-sm font-bold bg-blue-50 text-blue-600 block';

            const promise = isLoginMode ? auth.signInWithEmailAndPassword(email, pass) : auth.createUserWithEmailAndPassword(email, pass);
            
            promise.catch(err => {
                msg.textContent = err.message;
                msg.className = 'p-2 rounded text-sm font-bold bg-red-50 text-red-600 block';
            });
        });

        function logout() { auth.signOut(); }

        // --- 6. منطق التطبيق (Dashboard) ---
        async function initializeApp() {
            await loadSettings();
            await loadSession();
            updateUI();
            updateDateTime();
            
            // تحديث حالة المسؤول في واجهة الإعدادات
            const isAdmin = currentUser.email === ADMIN_EMAIL;
            document.getElementById('admin-warning').classList.toggle('hidden', isAdmin);
            document.getElementById('saveSettingsBtn').disabled = !isAdmin;
            if(!isAdmin) document.getElementById('saveSettingsBtn').classList.add('opacity-50', 'cursor-not-allowed');
            else document.getElementById('saveSettingsBtn').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function loadSettings() {
            return db.ref('molino_app_data/settings').once('value').then(snap => {
                if(snap.val()) appSettings = { ...appSettings, ...snap.val() };
                renderSiloSettingsInputs();
                renderGauges();
                updateSiloSelect();
            });
        }

        function loadSession() {
            return db.ref(`molino_app_data/sessions/${currentUser.uid}`).once('value').then(snap => {
                const data = snap.val();
                // التأكد من أن البيانات هي مصفوفة إذا كانت غير فارغة
                currentSession = data ? Object.values(data).sort((a,b) => a.ts - b.ts) : [];
                renderRecords();
            });
        }

        function updateUI() {
            // تحديث العدادات (Gauges)
            appSettings.SILOS.forEach(silo => {
                const recs = currentSession.filter(r => r.silo === silo.name).sort((a,b) => a.ts - b.ts);
                const lastWeight = recs.length ? parseFloat(recs[recs.length-1].weight) : 0;
                updateGauge(silo.id, lastWeight, silo.rated, silo.max);
            });
            document.getElementById('session-counter').textContent = `${currentSession.length} قراءات`;
        }

        function renderGauges() {
            const container = document.getElementById('gauges-container');
            container.innerHTML = appSettings.SILOS.map(s => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-sm text-slate-700">${s.name}</span>
                        <span class="font-mono font-bold text-blue-600" id="val-${s.id}">0.00 T</span>
                    </div>
                    <div class="h-4 bg-slate-100 rounded-full overflow-hidden flex relative">
                        <div id="bar-norm-${s.id}" class="h-full bg-green-500 gauge-bar" style="width: 0%"></div>
                        <div id="bar-ext-${s.id}" class="h-full bg-red-500 gauge-bar" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>0</span>
                        <span>Rated: ${s.rated}</span>
                        <span>Max: ${s.max}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateGauge(id, val, rated, max) {
            document.getElementById(`val-${id}`).textContent = val.toFixed(2) + ' T';
            const normBar = document.getElementById(`bar-norm-${id}`);
            const extBar = document.getElementById(`bar-ext-${id}`);
            
            normBar.classList.remove('bg-yellow-500', 'bg-green-500');
            extBar.classList.remove('bg-red-500', 'blinking');

            if (val <= rated) {
                // الوضع الطبيعي
                normBar.style.width = `${(val/rated)*100}%`;
                extBar.style.width = '0%';
                normBar.classList.add(val > rated * 0.9 ? 'bg-yellow-500' : 'bg-green-500');
            } else {
                // تجاوز الحد المقدر
                normBar.style.width = '100%';
                normBar.classList.add('bg-yellow-500');
                
                const extPerc = ((val - rated) / (max - rated)) * 100;
                extBar.style.width = `${Math.min(extPerc, 100)}%`;
                extBar.classList.add('bg-red-500');
                
                if(val >= max) extBar.classList.add('blinking');
            }
        }

        // --- 7. إدخال البيانات ---
        document.getElementById('entryForm').addEventListener('submit', async e => {
            e.preventDefault();
            const siloName = document.getElementById('silounSelect').value;
            const weightInput = document.getElementById('weightInput');
            const weight = parseFloat(weightInput.value);
            const dateVal = document.getElementById('dateTimeInput').value;
            
            if (isNaN(weight) || weight < 0 || !siloName || !dateVal) {
                alert("يرجى إدخال بيانات صحيحة.");
                return;
            }

            // حساب الفرق
            const prevRecs = currentSession.filter(r => r.silo === siloName).sort((a,b) => a.ts - b.ts);
            const prevW = prevRecs.length ? parseFloat(prevRecs[prevRecs.length-1].weight) : 0;
            const diff = prevRecs.length ? (weight - prevW).toFixed(2) : 'بداية';
            
            // التأكد من أن القراءة الجديدة أكبر أو تساوي القراءة السابقة
            if (prevRecs.length && weight < prevW) {
                if (!confirm(`تحذير: الوزن الجديد (${weight}) أقل من الوزن السابق (${prevW}). هل تريد التسجيل على أي حال؟`)) {
                    return;
                }
            }


            const record = {
                id: Date.now(),
                ts: new Date(dateVal).getTime(),
                dateStr: dateVal,
                silo: siloName,
                weight: weight,
                diff: diff
            };

            // إضافة السجل في موضعه الصحيح بناءً على الوقت
            currentSession.push(record);
            currentSession.sort((a,b) => a.ts - b.ts); 
            
            await db.ref(`molino_app_data/sessions/${currentUser.uid}/${record.id}`).set(record);
            
            updateUI();
            renderRecords();
            weightInput.value = '';
            updateDateTime();
        });

        function renderRecords() {
            const tbody = document.getElementById('recordsBody');
            // عرض القراءات بترتيب زمني عكسي
            tbody.innerHTML = [...currentSession].sort((a,b) => b.ts - a.ts).map(r => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-3 text-gray-500">${new Date(r.dateStr).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="p-3 font-bold">${r.silo}</td>
                    <td class="p-3">${r.weight.toFixed(2)}</td>
                    <td class="p-3 ${parseFloat(r.diff) > 0 ? 'text-green-600' : parseFloat(r.diff) < 0 ? 'text-red-500' : 'text-gray-400'}">${r.diff}</td>
                    <td class="p-3"><button onclick="deleteRec(${r.id})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteRec(id) {
            if(!confirm('هل أنت متأكد من حذف هذه القراءة؟')) return;
            
            // إعادة حساب الفروقات بعد الحذف (معقد قليلاً لكن مهم)
            const deletedRec = currentSession.find(r => r.id === id);
            if (!deletedRec) return;

            currentSession = currentSession.filter(r => r.id !== id);
            
            // إعادة حساب الفرق للسجل التالي
            const nextRec = currentSession.find(r => r.ts > deletedRec.ts && r.silo === deletedRec.silo);
            if (nextRec) {
                const prevRecOfNext = currentSession.filter(r => r.ts < nextRec.ts && r.silo === nextRec.silo).sort((a,b) => a.ts - b.ts).pop();
                const newPrevWeight = prevRecOfNext ? parseFloat(prevRecOfNext.weight) : 0;
                nextRec.diff = (parseFloat(nextRec.weight) - newPrevWeight).toFixed(2);
                // تحديث قاعدة البيانات للسجل التالي
                await db.ref(`molino_app_data/sessions/${currentUser.uid}/${nextRec.id}`).update({ diff: nextRec.diff });
            }


            await db.ref(`molino_app_data/sessions/${currentUser.uid}/${id}`).remove();
            
            updateUI();
            renderRecords();
        }

        // --- 8. Gemini AI (التحليل الذكي) ---
        async function callGemini(prompt, isJson = false) {
            // التحقق من مفتاح API
            if (!GEMINI_API_KEY) throw new Error("GEMINI API Key is missing. Cannot connect.");
            
            // تنفيذ Exponential Backoff للتعامل مع أخطاء 429
            for (let i = 0; i < 3; i++) {
                try {
                    const res = await fetch(GEMINI_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (res.status === 429) throw new Error('Too Many Requests. Try again later.');
                    if (!res.ok) throw new Error(`API Error: ${res.statusText}`);

                    const data = await res.json();
                    if (!data.candidates || data.candidates.length === 0) {
                        throw new Error('Gemini API returned no content.');
                    }
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    if (i === 2) throw e;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i))); // انتظار 1, 2, ثم 4 ثواني
                }
            }
        }

        function calculateSessionSpeed(records) {
            if (records.length < 2) return null;

            const relevantRecords = records.filter(r => parseFloat(r.diff) > 0);
            if (relevantRecords.length < 1) return 0;
            
            const totalDiff = relevantRecords.reduce((acc, curr) => acc + parseFloat(curr.diff), 0);

            const firstTs = records[0].ts;
            const lastTs = records[records.length - 1].ts;
            const durationHours = (lastTs - firstTs) / (1000 * 60 * 60);

            return durationHours > 0 ? (totalDiff / durationHours).toFixed(2) : totalDiff.toFixed(2);
        }

        async function analyzeCurrentSession() {
            const btn = document.getElementById('analyzeBtn');
            const resultDiv = document.getElementById('ai-analysis-result');
            
            if(currentSession.length < 2) {
                alert("يرجى إدخال قراءتين على الأقل للتحليل.");
                return;
            }
            
            const originalBtnHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loader border-indigo-600 border-t-transparent w-4 h-4 ml-2"></span> جاري التحليل...';
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = "يقوم Gemini بقراءة بياناتك الآن...";

            // حساب السرعة محلياً
            const speed = calculateSessionSpeed(currentSession);
            
            // تجهيز البيانات للنص
            const dataSummary = currentSession.map(r => 
                `الخزان: ${r.silo}, الوزن: ${r.weight}T, الفرق: ${r.diff}T, الوقت: ${r.dateStr.split('T')[1]}`
            ).join('\n');

            const speedText = speed !== null ? `(السرعة المحسوبة محلياً: ${speed} طن/ساعة).` : '';

            const prompt = `
            Act as an industrial efficiency expert. Analyze this silo production data in ARABIC language.
            Data:
            ${dataSummary}
            ${speedText}
            
            Required Output:
            1. Calculate estimated speed (Tons/Hour) if possible. (Should be similar to ${speedText})
            2. Give 2 strengths (نقاط قوة).
            3. Give 2 warnings or suggestions (تنبيهات/اقتراحات).
            Keep it professional and concise. Use proper Markdown for formatting.
            `;

            try {
                const response = await callGemini(prompt);
                // تنسيق الرد ليظهر بشكل جميل
                const formatted = response.replace(/\*\*(.*?)\*\*/g, '<strong class="text-yellow-300">$1</strong>')
                                          .replace(/\n/g, '<br>');
                resultDiv.innerHTML = formatted;
            } catch (err) {
                resultDiv.innerHTML = `<span class="text-red-300">حدث خطأ في الاتصال: ${err.message}. يرجى التحقق من المفتاح والاتصال بالإنترنت.</span>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        }

        async function handleChat() {
            const input = document.getElementById('chatInput');
            const history = document.getElementById('chatHistory');
            const loader = document.getElementById('chat-loader');
            const txt = input.value.trim();
            if(!txt) return;

            // إضافة رسالة المستخدم
            history.innerHTML += `
                <div class="flex justify-end animate-fadeIn">
                    <div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tl-none shadow-md max-w-[85%] text-sm">${txt}</div>
                </div>
            `;
            input.value = '';
            history.scrollTop = history.scrollHeight;
            loader.classList.remove('hidden');

            try {
                const response = await callGemini("User is asking in Arabic about Molino Silo System or general technical advice: " + txt);
                const formatted = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                
                history.innerHTML += `
                    <div class="flex justify-start animate-fadeIn">
                        <div class="bg-white border border-slate-200 text-slate-700 p-3 rounded-2xl rounded-tr-none shadow-sm max-w-[85%] text-sm leading-relaxed">
                            <i class="fa-solid fa-robot text-blue-500 ml-1"></i> ${formatted}
                        </div>
                    </div>
                `;
            } catch (err) {
                history.innerHTML += `<div class="text-center text-xs text-red-400 my-2">فشل الاتصال بالمساعد: ${err.message}</div>`;
            } finally {
                loader.classList.add('hidden');
                history.scrollTop = history.scrollHeight;
            }
        }

        // --- 9. الوظائف المساعدة والإعدادات ---
        function updateSiloSelect() {
            const sel = document.getElementById('silounSelect');
            sel.innerHTML = appSettings.SILOS.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        function renderSiloSettingsInputs() {
            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
            const container = document.getElementById('siloSettingsContainer');
            container.innerHTML = appSettings.SILOS.map((s, i) => `
                <div class="grid grid-cols-3 gap-2 items-center bg-slate-50 p-2 rounded">
                    <input type="text" value="${s.name}" data-key="name" data-id="${s.id}" class="p-1 border rounded w-full text-xs text-right" ${!isAdmin ? 'disabled' : ''}>
                    <input type="number" value="${s.rated}" data-key="rated" data-id="${s.id}" class="p-1 border rounded w-full text-xs text-left" ${!isAdmin ? 'disabled' : ''}>
                    <input type="number" value="${s.max}" data-key="max" data-id="${s.id}" class="p-1 border rounded w-full text-xs text-left" ${!isAdmin ? 'disabled' : ''}>
                </div>
            `).join('');
        }

        function addSiloField() {
            // هذه الوظيفة تتطلب منطقاً معقداً لتوليد ID فريد وإضافته للـ SILOS
            alert("وظيفة الإضافة غير مفعلة حالياً. يمكنك التعديل على الخزانات الموجودة فقط.");
            // يمكن تطبيقها عبر:
            // const newId = appSettings.SILOS.length ? Math.max(...appSettings.SILOS.map(s => s.id)) + 1 : 1;
            // appSettings.SILOS.push({ id: newId, name: `Siloun ${newId}`, rated: 63, max: 75 });
            // renderSiloSettingsInputs();
        }

        document.getElementById('settingsForm').addEventListener('submit', async e => {
            e.preventDefault();
            if(currentUser.email !== ADMIN_EMAIL) return;

            const newSilos = [];
            const inputs = document.querySelectorAll('#siloSettingsContainer input');
            
            // جمع البيانات من الحقول
            appSettings.SILOS.forEach(silo => {
                const nameInput = document.querySelector(`input[data-key="name"][data-id="${silo.id}"]`);
                const ratedInput = document.querySelector(`input[data-key="rated"][data-id="${silo.id}"]`);
                const maxInput = document.querySelector(`input[data-key="max"][data-id="${silo.id}"]`);
                
                newSilos.push({
                    id: silo.id,
                    name: nameInput.value.trim(),
                    rated: parseFloat(ratedInput.value),
                    max: parseFloat(maxInput.value)
                });
            });

            // تحديث الإعدادات في التطبيق وقاعدة البيانات
            appSettings.SILOS = newSilos;
            try {
                await db.ref('molino_app_data/settings').update({ SILOS: newSilos });
                alert('تم حفظ إعدادات الخزانات بنجاح!');
                // إعادة تهيئة الواجهة
                renderGauges();
                updateSiloSelect();
                updateUI();
            } catch (error) {
                alert('حدث خطأ أثناء حفظ الإعدادات: ' + error.message);
            }
        });


        function updateDateTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            // يعرض التوقيت المحلي للمستخدم
            document.getElementById('dateTimeInput').value = new Date(now.getTime() - offset).toISOString().slice(0, 16);
        }

        async function endWork() {
            if(!currentSession.length) return alert('لا يوجد بيانات لتسجيلها.');
            if(!confirm('هل أنت متأكد من إنهاء الجلسة وحفظها في الأرشيف؟ سيتم مسح بيانات الجلسة الحالية.')) return;

            const speed = calculateSessionSpeed(currentSession);

            const summary = {
                date: new Date().toISOString(),
                total: currentSession.reduce((acc, curr) => acc + (parseFloat(curr.diff) > 0 ? parseFloat(curr.diff) : 0), 0).toFixed(2),
                speed: speed,
                count: currentSession.length,
                records: currentSession
            };

            const timestamp = Date.now();
            await db.ref(`molino_app_data/history/${currentUser.uid}/${timestamp}`).set(summary);
            await db.ref(`molino_app_data/sessions/${currentUser.uid}`).remove();
            
            alert('تم الحفظ بنجاح! إجمالي الإنتاج: ' + summary.total + ' طن.');
            currentSession = [];
            updateUI(); // لتصفير العدادات والجدول
            renderRecords();
            switchTab('history'); // الانتقال للأرشيف
        }

        function loadUserHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><span class="loader w-4 h-4 ml-2"></span> جاري التحميل...</td></tr>';
            
            db.ref(`molino_app_data/history/${currentUser.uid}`).limitToLast(10).once('value').then(snap => {
                tbody.innerHTML = '';
                if(!snap.val()) { tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4">لا يوجد أرشيف</td></tr>'; return; }
                
                Object.values(snap.val()).reverse().forEach(h => {
                    const dateStr = new Date(h.date).toLocaleDateString('ar-SA', { year: 'numeric', month: 'short', day: 'numeric' });
                    const totalT = parseFloat(h.total).toFixed(2) || '0.00';
                    const speedT = parseFloat(h.speed).toFixed(2) || 'N/A';
                    
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50">
                            <td class="p-3">${dateStr}</td>
                            <td class="p-3 font-bold text-green-600">${totalT}</td>
                            <td class="p-3 text-sm">${speedT} T/h</td>
                            <td class="p-3 text-xs text-gray-400">${h.count} قراءة</td>
                        </tr>
                    `;
                });
            }).catch(error => {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">خطأ في تحميل الأرشيف: ${error.message}</td></tr>`;
            });
        }
        
        async function factoryReset() {
            if(!currentUser || currentUser.email !== ADMIN_EMAIL) {
                alert("لا تملك صلاحيات المسؤول لإجراء هذه العملية.");
                return;
            }
            if(!confirm("تحذير خطير: هل أنت متأكد من حذف جميع بيانات المصنع (الجلسات والأرشيف)؟ لا يمكن التراجع!")) return;
            
            try {
                await db.ref('molino_app_data').remove();
                alert("تم حذف جميع البيانات وإعادة ضبط المصنع بنجاح. سيتم تسجيل الخروج الآن.");
                logout();
            } catch (error) {
                alert("فشل إعادة ضبط المصنع: " + error.message);
            }
        }

        // --- رسوم بيانية بسيطة ---
        function showCharts() {
            document.getElementById('chartsModal').classList.remove('hidden');
            
            // تدمير الرسوم البيانية القديمة قبل إنشاء الجديدة
            if(charts.w) charts.w.destroy();
            if(charts.d) charts.d.destroy();

            const siloNames = appSettings.SILOS.map(s=>s.name);
            const currentWeights = appSettings.SILOS.map(s => {
                const recs = currentSession.filter(r => r.silo === s.name);
                return recs.length ? parseFloat(recs[recs.length-1].weight) : 0;
            });

            const ctxW = document.getElementById('chartWeights').getContext('2d');
            charts.w = new Chart(ctxW, {
                type: 'bar',
                data: {
                    labels: siloNames,
                    datasets: [{ 
                        label: 'الوزن الحالي (T)', 
                        data: currentWeights, 
                        backgroundColor: currentWeights.map((w, i) => w > appSettings.SILOS[i].rated ? '#f59e0b' : '#3b82f6')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            const ctxD = document.getElementById('chartDiff').getContext('2d');
            const recs = [...currentSession].sort((a,b)=>a.ts-b.ts);
            charts.d = new Chart(ctxD, {
                type: 'line',
                data: {
                    labels: recs.map(r => `${new Date(r.dateStr).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})} (${r.silo})`),
                    datasets: [{ 
                        label: 'فروقات الوزن الإيجابية (T)', 
                        data: recs.map(r=>parseFloat(r.diff)>0 ? parseFloat(r.diff) : 0), 
                        borderColor: '#10b981', 
                        tension: 0.3,
                        pointBackgroundColor: '#10b981',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

    </script>
</body>
</html>

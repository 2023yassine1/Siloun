<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Molino Ù„Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</title>
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS Ù„Ù„Ø³ØªØ§ÙŠÙ„ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e3a8a',
                        'primary-light': '#3b82f6',
                        'secondary-green': '#10b981',
                        'secondary-red': '#ef4444',
                        'bg-dark': '#0f172a',
                        'card-bg': '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        /* ØªØµÙ…ÙŠÙ… Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #1e3a8a; }
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card {
            background-color: #1e293b;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Loading Effect) */
        .loading-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* Ù†Ù…Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .main-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="text-white min-h-screen p-4 md:p-8">

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <header class="flex justify-between items-center pb-6 border-b border-gray-700 mb-6">
        <h1 class="text-3xl font-extrabold text-primary-light">Ù†Ø¸Ø§Ù… Molino</h1>
        <div id="user-info" class="text-sm flex items-center space-x-2 space-x-reverse">
            <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID) Ù‡Ù†Ø§ -->
            <span class="text-gray-400">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
            <span id="user-id" class="font-mono bg-card-bg px-2 py-1 rounded-full text-xs truncate max-w-[150px] md:max-w-none loading-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
    </header>

    <main id="app-content" class="space-y-6">

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Current Session Panel) -->
        <section class="card p-5">
            <h2 class="text-xl font-bold mb-4 text-primary-light flex items-center space-x-2 space-x-reverse">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" />
                </svg>
                Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            </h2>
            
            <div id="current-session-data" class="grid grid-cols-2 gap-4 text-sm mb-6">
                <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
                <div class="bg-gray-800 p-3 rounded-md">
                    <p class="text-gray-400">Ø§Ù„Ø­Ø§Ù„Ø©:</p>
                    <p id="session-status" class="font-bold text-secondary-red">Ù…ØªÙˆÙ‚ÙØ©</p>
                </div>
                <div class="bg-gray-800 p-3 rounded-md">
                    <p class="text-gray-400">ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡:</p>
                    <p id="start-time" class="font-bold">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</p>
                </div>
                <div class="bg-gray-800 p-3 rounded-md col-span-2">
                    <p class="text-gray-400">ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ):</p>
                    <p id="current-production" class="text-2xl font-extrabold text-secondary-green loading-pulse">0 ÙƒØºÙ…</p>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="flex flex-col space-y-3">
                <button id="start-session-btn" 
                        class="main-button bg-secondary-green hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg w-full disabled:opacity-50"
                        disabled>
                    Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
                <button id="stop-session-btn" 
                        class="main-button bg-secondary-red hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg w-full disabled:opacity-50"
                        disabled>
                    Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                </button>
            </div>
        </section>

        <!-- Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹ (ADMIN ONLY) -->
        <section class="card p-5">
            <h2 class="text-xl font-bold mb-4 text-primary-light flex items-center space-x-2 space-x-reverse">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM17 4a1 1 0 10-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4z" />
                </svg>
                Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹ (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·)
            </h2>
            
            <div id="admin-panel" class="space-y-4" style="display: none;">
                <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø© Ø§Ù„Ø®Ø²Ø§Ù† -->
                <div>
                    <label for="tank-capacity-input" class="block text-sm font-medium text-gray-400 mb-1">Ø³Ø¹Ø© Ø®Ø²Ø§Ù† Molino (ÙƒØºÙ…):</label>
                    <input type="number" id="tank-capacity-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø©" 
                           class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:ring-primary-light focus:border-primary-light">
                </div>
                <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ø§Ù„ Ù„Ù„ØªØ­ÙƒÙ…) -->
                <div>
                    <label for="status-color-input" class="block text-sm font-medium text-gray-400 mb-1">Ù„ÙˆÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø¨Ø§Ù„ÙƒÙˆØ¯ Hex):</label>
                    <input type="text" id="status-color-input" placeholder="#10b981" 
                           class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:ring-primary-light focus:border-primary-light">
                </div>
                
                <button id="save-settings-btn" 
                        class="main-button bg-primary-light hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg w-full disabled:opacity-50">
                    Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </button>
            </div>
            
            <p id="admin-message" class="text-sm text-gray-400 p-2 rounded-md bg-gray-800">
                <span class="text-secondary-red">ğŸš« Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</span>
                <br>
                Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·.
            </p>
        </section>

        <!-- Ù„ÙˆØ­Ø© Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (History) -->
        <section class="card p-5">
            <h2 class="text-xl font-bold mb-4 text-primary-light flex items-center space-x-2 space-x-reverse">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h5a1 1 0 000-2H6z" clip-rule="evenodd" />
                </svg>
                Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            </h2>
            <div id="history-list" class="space-y-3">
                <p id="history-loading" class="text-gray-500 loading-pulse">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ...</p>
                <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù‡Ù†Ø§ -->
            </div>
        </section>
        
        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¹Ø§Ù…Ø© (Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… alert) -->
        <div id="message-box" class="fixed bottom-4 right-4 bg-secondary-red text-white p-3 rounded-lg shadow-xl hidden z-50 transition-opacity duration-300"></div>

    </main>

    <script type="module">
        // ----------------------------------------------------
        // I. Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙƒÙˆÙŠÙ† Firebase
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            onSnapshot, 
            serverTimestamp,
            getDocs,
            query,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ØªÙØ¹ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Firebase (Ù„Ù„ØªØµØ­ÙŠØ­)
        setLogLevel('Debug');

        // Ù…ØªØºÙŠØ±Ø§Øª Firebase Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-molino-app-id';
        
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†)
        const ADMIN_EMAIL = 'koreanarabione@gmail.com'; // âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯
        
        let app, db, auth, userId = null;
        let isUserAdmin = false;
        let unsubscribeSession = null;
        let unsubscribeHistory = null;
        let settings = {};

        // ----------------------------------------------------
        // II. Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© (DOM Elements)
        // ----------------------------------------------------
        const userIdSpan = document.getElementById('user-id');
        const sessionStatus = document.getElementById('session-status');
        const startTimeEl = document.getElementById('start-time');
        const currentProductionEl = document.getElementById('current-production');
        const startBtn = document.getElementById('start-session-btn');
        const stopBtn = document.getElementById('stop-session-btn');
        const adminPanel = document.getElementById('admin-panel');
        const adminMessage = document.getElementById('admin-message');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const tankCapacityInput = document.getElementById('tank-capacity-input');
        const statusColorInput = document.getElementById('status-color-input');
        const historyList = document.getElementById('history-list');
        const messageBox = document.getElementById('message-box');


        // ----------------------------------------------------
        // III. Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ----------------------------------------------------

        /** * @description Displays a temporary message box instead of alert().
         * @param {string} message The message to display.
         * @param {string} type 'success' or 'error'.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-secondary-green', 'bg-secondary-red');
            if (type === 'success') {
                messageBox.classList.add('bg-secondary-green');
            } else {
                messageBox.classList.add('bg-secondary-red');
            }
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø«Ù… Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * @description Generates the Firestore path for the user's private data.
         * @param {string} collectionName The collection name (e.g., 'sessions', 'history').
         * @returns {string} The full path.
         */
        function getPrivatePath(collectionName) {
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }
        
        /**
         * @description Generates the Firestore path for the public data (Settings).
         * @param {string} docName The document name (e.g., 'config').
         * @returns {string} The full path.
         */
        function getPublicPath(docName) {
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø³Ø§Ø± Ù‡Ù†Ø§ Ù‡Ùˆ /artifacts/{appId}/public/data/settings/config
            return `artifacts/${appId}/public/data/settings/${docName}`;
        }

        /**
         * @description Formats a Firestore Timestamp object into a readable string.
         * @param {object} timestamp The Firestore Timestamp object.
         * @returns {string} The formatted date/time string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            // ØªØ­ÙˆÙŠÙ„ timestamp Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Date
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'medium' });
        }
        
        // ----------------------------------------------------
        // IV. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Handlers)
        // ----------------------------------------------------

        /**
         * @description Starts a new Molino session.
         */
        async function startSession() {
            if (!userId) {
                showMessage('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯.', 'error');
                return;
            }
            
            try {
                // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                // Ø§Ù„Ù…Ø³Ø§Ø±: artifacts/{appId}/users/{userId}/sessions/current
                const sessionDocRef = doc(db, getPrivatePath('sessions'), 'current');
                
                await setDoc(sessionDocRef, {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… serverTimestamp Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© ÙˆÙ‚Øª Ø§Ù„Ø®Ø§Ø¯Ù…
                    startTime: serverTimestamp(),
                    isRunning: true,
                    productionKg: 0,
                    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§
                }, { merge: true }); // Ø§Ø³ØªØ®Ø¯Ø§Ù… merge Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª

                showMessage('ØªÙ… Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Molino Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                console.error("Error starting session:", error);
                showMessage(`Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©: ${error.message}`, 'error');
            }
        }

        /**
         * @description Stops the current session and archives the data.
         */
        async function stopSession() {
            if (!userId) return;

            // 1. Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const sessionDocRef = doc(db, getPrivatePath('sessions'), 'current');
            const sessionSnap = await getDoc(sessionDocRef);
            
            if (!sessionSnap.exists() || !sessionSnap.data().isRunning) {
                showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø© Ù„Ø¥Ù†Ù‡Ø§Ø¡Ù‡Ø§.', 'error');
                return;
            }

            const sessionData = sessionSnap.data();
            
            try {
                // 2. Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (History)
                // Ø§Ù„Ù…Ø³Ø§Ø±: artifacts/{appId}/users/{userId}/history
                const historyCollectionRef = collection(db, getPrivatePath('history'));
                await addDoc(historyCollectionRef, {
                    ...sessionData,
                    endTime: serverTimestamp(),
                    durationMinutes: calculateDuration(sessionData.startTime), // ÙˆØ¸ÙŠÙØ© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø©
                    // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø«Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©
                });

                // 3. Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§
                await setDoc(sessionDocRef, {
                    isRunning: false,
                    productionKg: 0,
                    startTime: null
                }, { merge: true });
                
                showMessage('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ!', 'success');
            } catch (error) {
                console.error("Error stopping and archiving session:", error);
                showMessage(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©: ${error.message}`, 'error');
            }
        }
        
        /**
         * @description A simple function to simulate production increase (for demo).
         * NOTE: In a real app, this data would come from an external IoT device writing to Firebase.
         */
        async function simulateProductionIncrease() {
            if (!userId) return;
            
            try {
                const sessionDocRef = doc(db, getPrivatePath('sessions'), 'current');
                const sessionSnap = await getDoc(sessionDocRef);
                
                if (sessionSnap.exists() && sessionSnap.data().isRunning) {
                    const currentData = sessionSnap.data();
                    
                    // Ø²ÙŠØ§Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹ 50 ÙƒØºÙ… ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ)
                    const newProduction = (currentData.productionKg || 0) + 50; 
                    
                    await setDoc(sessionDocRef, {
                        productionKg: newProduction
                    }, { merge: true });
                }
            } catch (error) {
                // Ù„Ø§ ØªØ³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‡Ù†Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ´ÙˆÙŠØ´ ÙÙŠ ÙƒÙ„ ØªÙƒØ±Ø§Ø±
            }
        }
        
        /**
         * @description Saves factory settings (Admin only).
         */
        async function saveSettings() {
            if (!isUserAdmin) {
                showMessage('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'error');
                return;
            }
            
            const capacity = parseInt(tankCapacityInput.value, 10);
            const color = statusColorInput.value.trim();

            if (isNaN(capacity) || capacity <= 0) {
                showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø© Ø®Ø²Ø§Ù† ØµØ­ÙŠØ­Ø©.', 'error');
                return;
            }
            
            try {
                // Ø§Ù„Ù…Ø³Ø§Ø±: artifacts/{appId}/public/data/settings/config
                const settingsDocRef = doc(db, getPublicPath('config'));
                await setDoc(settingsDocRef, {
                    tankCapacity: capacity,
                    statusColor: color,
                    lastUpdated: serverTimestamp()
                });
                showMessage('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                console.error("Error saving settings:", error);
                showMessage(`Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ${error.message}`, 'error');
            }
        }
        
        /**
         * @description Calculates duration in minutes from Firestore Timestamp.
         */
        function calculateDuration(startTime) {
            if (!startTime) return 0;
            const startMs = startTime.toDate ? startTime.toDate().getTime() : new Date(startTime).getTime();
            const nowMs = new Date().getTime();
            return Math.floor((nowMs - startMs) / 60000); // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        }
        
        // ----------------------------------------------------
        // V. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© (Realtime Listeners)
        // ----------------------------------------------------

        /**
         * @description Sets up the listener for the user's current session data.
         */
        function setupSessionListener() {
            if (unsubscribeSession) unsubscribeSession();
            
            const sessionDocRef = doc(db, getPrivatePath('sessions'), 'current');

            unsubscribeSession = onSnapshot(sessionDocRef, (docSnap) => {
                const data = docSnap.data();
                if (docSnap.exists() && data && data.isRunning) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„"
                    sessionStatus.textContent = 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„';
                    sessionStatus.classList.remove('text-secondary-red');
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø£Ùˆ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    const statusColor = settings.statusColor || 'text-secondary-green';
                    sessionStatus.style.color = statusColor;
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡
                    startTimeEl.textContent = formatTimestamp(data.startTime);
                    
                    // ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
                    const production = (data.productionKg || 0).toLocaleString();
                    currentProductionEl.textContent = `${production} ÙƒØºÙ…`;
                    currentProductionEl.classList.remove('loading-pulse');

                    // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù…ØªÙˆÙ‚ÙØ©"
                    sessionStatus.textContent = 'Ù…ØªÙˆÙ‚ÙØ©';
                    sessionStatus.classList.remove('text-secondary-green');
                    sessionStatus.style.color = ''; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø®ØµØµ
                    sessionStatus.classList.add('text-secondary-red');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    startTimeEl.textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    currentProductionEl.textContent = '0 ÙƒØºÙ…';
                    currentProductionEl.classList.remove('loading-pulse');

                    // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            }, (error) => {
                console.error("Error listening to session data:", error);
                showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
            });
        }
        
        /**
         * @description Sets up the listener for the factory settings (public data).
         */
        function setupSettingsListener() {
             const settingsDocRef = doc(db, getPublicPath('config'));
             
             // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
             onSnapshot(settingsDocRef, (docSnap) => {
                 if (docSnap.exists()) {
                     settings = docSnap.data();
                     
                     // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                     tankCapacityInput.value = settings.tankCapacity || '';
                     statusColorInput.value = settings.statusColor || '';
                     
                     // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„
                     const currentStatusColor = settings.statusColor || '';
                     if (sessionStatus.textContent === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„') {
                         sessionStatus.style.color = currentStatusColor;
                     }
                     
                 } else if (isUserAdmin) {
                     // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹
                      setDoc(settingsDocRef, {
                          tankCapacity: 1000,
                          statusColor: '#10b981',
                          lastUpdated: serverTimestamp()
                      }, { merge: true });
                 }
             }, (error) => {
                 console.error("Error listening to settings data:", error);
             });
        }

        /**
         * @description Sets up the listener for the user's history data.
         */
        function setupHistoryListener() {
            if (unsubscribeHistory) unsubscribeHistory();

            const historyCollectionRef = collection(db, getPrivatePath('history'));
            // Ø§Ø³ØªØ¹Ù„Ø§Ù…: Ø¬Ù„Ø¨ Ø¢Ø®Ø± 10 Ø¹Ù…Ù„ÙŠØ§ØªØŒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… limit
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… orderBy Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³Ø© (Indexes)
            const q = query(historyCollectionRef, limit(10)); 

            unsubscribeHistory = onSnapshot(q, (snapshot) => {
                historyList.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                
                if (snapshot.empty) {
                    historyList.innerHTML = '<p id="history-loading" class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯.</p>';
                    return;
                }
                
                // ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                const sortedHistory = snapshot.docs
                    .map(doc => doc.data())
                    .sort((a, b) => (b.endTime?.seconds || 0) - (a.endTime?.seconds || 0));

                sortedHistory.forEach(data => {
                    const duration = data.startTime ? calculateDuration(data.startTime) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    
                    const item = document.createElement('div');
                    item.className = 'card p-4 border-r-4 border-primary-light';
                    item.innerHTML = `
                        <p class="text-lg font-semibold text-primary-light">Ø¹Ù…Ù„ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø©</p>
                        <p class="text-sm text-gray-400">Ø¨Ø¯Ø£Øª: ${formatTimestamp(data.startTime)}</p>
                        <p class="text-sm text-gray-400">Ø§Ù†ØªÙ‡Øª: ${formatTimestamp(data.endTime || 'Ù„Ù… ØªÙƒØªÙ…Ù„')}</p>
                        <div class="mt-2 flex justify-between items-center">
                             <span class="text-xl font-bold text-secondary-green">${(data.productionKg || 0).toLocaleString()} ÙƒØºÙ…</span>
                             <span class="text-sm text-gray-500">${duration} Ø¯Ù‚ÙŠÙ‚Ø©</span>
                        </div>
                    `;
                    historyList.appendChild(item);
                });
            }, (error) => {
                console.error("Error listening to history data:", error);
                historyList.innerHTML = '<p class="text-secondary-red">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.</p>';
            });
        }
        
        // ----------------------------------------------------
        // VI. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ (Initialization)
        // ----------------------------------------------------
        
        /**
         * @description Main function to initialize Firebase and listeners.
         */
        async function initializeAppAndAuth() {
            try {
                // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 2. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø®ØµØµ Ø£Ùˆ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        userIdSpan.classList.remove('loading-pulse');
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                        isUserAdmin = (user.email === ADMIN_EMAIL);
                        if (isUserAdmin) {
                            adminPanel.style.display = 'block';
                            adminMessage.style.display = 'none';
                        } else {
                            adminPanel.style.display = 'none';
                            adminMessage.style.display = 'block';
                        }
                        
                        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        setupSettingsListener(); // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø£ÙˆÙ„ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                        setupSessionListener();
                        setupHistoryListener();
                        
                        // Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
                        setInterval(simulateProductionIncrease, 5000); 

                    } else {
                        userIdSpan.textContent = 'ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚';
                        userIdSpan.classList.remove('loading-pulse');
                        // ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©ØŒ ÙŠÙØ¶Ù„ Ø¹Ø¯Ù… ØªØ´ØºÙŠÙ„ Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
                    }
                });
                
            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                userIdSpan.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…';
                showMessage(`Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: ${error.message}`, 'error');
            }
        }

        // ----------------------------------------------------
        // VII. Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners)
        // ----------------------------------------------------
        
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);
        saveSettingsBtn.addEventListener('click', saveSettings);

        // Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>


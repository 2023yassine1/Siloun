<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOTAL SILOUN MOLINO - Smart AI V4.5 (Advanced Settings)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="manifest" href="molino_app.json">
    <link rel="apple-touch-icon" href="icon-192.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3498db">

    <style>
        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 0; color: #333; text-align: right; }
        .container { padding: 25px; max-width: 700px; margin: 20px auto; background-color: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 12px; }
        h1 { border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 25px; text-align: center; color: #2c3e50; }
        h2 { font-size: 1.2rem; margin-top: 25px; margin-bottom: 15px; border-right: 4px solid #3498db; padding-right: 10px; color: #2c3e50; }
        
        /* --- Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        input, select, button { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 16px; font-family: 'Segoe UI', sans-serif; }
        input[type="number"] { direction: ltr; text-align: right; }
        button { background-color: #28a745; color: white; cursor: pointer; border: none; font-weight: bold; transition: 0.3s; }
        button:hover { background-color: #218838; transform: translateY(-1px); }
        .secondary-btn { background-color: #6c757d; }
        .danger-btn { background-color: #dc3545; }
        .reset-btn { background-color: #8b0000; color: #ffcccc; margin-top: 10px; border: 1px solid #5a0000;} 
        .small-btn { width: auto; padding: 5px 10px; font-size: 12px; margin: 0; }
        .input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .input-group input, .input-group select { margin-bottom: 0; }

        /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #e9ecef; padding: 8px; text-align: center; }
        th { background-color: #3498db; color: white; }
        td { direction: ltr; unicode-bidi: embed; }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª (Gauges) --- */
        .gauge-container { margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa; }
        .gauge-labels { display: flex; justify-content: space-between; direction: ltr; margin-bottom: 8px; }
        .gauge-wrapper { display: flex; align-items: center; gap: 4px; height: 30px; }
        .gauge-main { flex-grow: 1; background-color: #e9ecef; border-radius: 6px 0 0 6px; height: 100%; overflow: hidden; position: relative; }
        .gauge-extension { width: 20%; background-color: #dedede; border-radius: 0 6px 6px 0; height: 100%; overflow: hidden; position: relative; border-left: 2px dashed #bbb; }
        .fill-bar { height: 100%; width: 0%; transition: width 0.6s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; }
        .gauge-sub-labels { display: flex; justify-content: space-between; font-size: 10px; color: #777; margin-top: 4px; }
        .blinking { animation: blinker var(--blink-speed) linear infinite; } @keyframes blinker { 50% { opacity: 0.7; } }

        /* --- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (AI Analysis) --- */
        #ai-card { background: linear-gradient(135deg, #f0f9ff 0%, #e1f5fe 100%); border: 1px solid #b3e5fc; border-radius: 10px; overflow: hidden; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .ai-header { background-color: #0288d1; color: white; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .ai-body { padding: 15px; }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .ai-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .ai-stat-box { background: white; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #b3e5fc; }
        .ai-value { display: block; font-size: 1.1rem; font-weight: bold; color: #0277bd; font-family: sans-serif; }
        .ai-label { font-size: 0.75rem; color: #546e7a; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØµÙŠØ§Øª */
        .ai-insights { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; }
        .ai-insights li { padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: flex-start; gap: 8px; background: rgba(255,255,255,0.6); margin-bottom: 5px; border-radius: 4px; }
        .ai-insights li:last-child { border-bottom: none; }
        
        /* Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ */
        .performance-bar-container { margin-top: 15px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 6px; }
        .perf-title { font-size: 0.85rem; color: #455a64; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .perf-progress-bg { height: 8px; background: #cfd8dc; border-radius: 4px; overflow: hidden; }
        .perf-progress-fill { height: 100%; background: #4caf50; width: 0%; transition: width 1s; }

        /* Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        .backup-section { background-color: #f1f1f1; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #ccc; }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ØµÙØ­Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© */
        #auth-page { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #3498db; }
        .auth-box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 400px; text-align: center; }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ù…Ù†ÙØµÙ„ (Modal) */
        .charts-modal, .settings-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .charts-content, .settings-content { background-color: #fefefe; margin: 2% auto; padding: 20px; width: 95%; max-width: 700px; border-radius: 12px; }
        .charts-content h2 { border-right: 4px solid #ffeb3b; color: #795548; }
        .settings-content h2 { border-right: 4px solid #f44336; color: #f44336; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 25px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        .chart-container h4 { text-align: center; color: #795548; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-bottom: 10px;}

        /* Ø²Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·) */
        .options-menu-btn { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            font-size: 24px; 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: #333; 
            width: auto; 
            padding: 5px;
            margin-bottom: 0;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø®Ø§Øµ) */
        #settingsForm label { display: block; font-weight: bold; margin-bottom: 5px; margin-top: 10px; }
        .silo-settings-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            align-items: center; 
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            background-color: #fafafa;
            flex-wrap: wrap;
        }
        .silo-settings-row > div { 
            flex: 1 1 45%; /* ÙŠØ³Ù…Ø­ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„Ù†Ù…Ùˆ ÙˆØ§Ù„ØªÙƒØ¯Ø³ */
            min-width: 150px;
        }
        .silo-settings-row input[type="text"], .silo-settings-row input[type="number"] {
            margin-bottom: 0;
            padding: 8px;
            width: 100%;
        }
        .silo-settings-row .silo-name-input {
            flex: 1 1 100%;
        }
        .silo-settings-row .silo-capacity-input {
            display: flex;
            align-items: center;
        }
        .silo-settings-row .silo-capacity-input span {
            flex-shrink: 0;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div id="auth-page">
    <div class="auth-box">
        <h2 id="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ‘‹</h2>
        <form id="authForm">
            <label style="display: block; text-align: right; margin-bottom: 5px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
            <input type="text" id="usernameInput" required placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            
            <label style="display: block; text-align: right; margin-bottom: 5px;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
            <input type="password" id="passwordInput" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            
            <p id="authMessage" class="auth-message" style="display: none;"></p>
            
            <button type="submit" id="authButton">Ø¯Ø®ÙˆÙ„</button>
            <span id="toggleAuth" class="toggle-link" onclick="toggleAuthMode()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span>
        </form>
    </div>
</div>

<div id="main-app" class="container" style="display:none;">
    <button class="options-menu-btn" onclick="showSettingsModal()">âš™ï¸</button>
    
    <h1>ğŸ­ TOTAL SILOUN MOLINO <span style="font-size:0.5em; color:#777;">AI V4.5</span></h1>
    <div style="text-align: left; margin-bottom: 15px;">
        <span style="font-size: 0.8em; color: #666;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ <strong id="loggedInUser"></strong></span>
        <button class="danger-btn small-btn" onclick="logout()" style="width: auto; margin-right: 10px;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <hr>
    
    <h2>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <form id="entryForm">
        <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø²Ø§Ù†:</label>
        <select id="silounSelect" required>
            </select>

        <label>Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (<span id="maxWeightDisplay">Max T</span>):</label>
        <input type="number" id="weightInput" min="0" step="0.01" required placeholder="Ù…Ø«Ø§Ù„: 64.50">
        
        <label>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
        <input type="datetime-local" id="dateTimeInput" required>

        <button type="submit">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
    </form>
    
    <hr>

    <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª (Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ…Ø¯ÙŠØ¯)</h2>
    <div id="gauges"></div>
    
    <div id="ai-card">
        <div class="ai-header">
            <span>ğŸ¤– Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¯Ø§Ø¡</span>
            <span id="liveStatus" style="font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</span>
        </div>
        <div class="ai-body">
            <div class="ai-stats-grid">
                <div class="ai-stat-box">
                    <span class="ai-value" id="aiSpeed">0.0</span>
                    <span class="ai-label">Ø§Ù„Ø³Ø±Ø¹Ø© (Ø·Ù†/Ø³Ø§Ø¹Ø©)</span>
                </div>
                <div class="ai-stat-box">
                    <span class="ai-value" id="aiTotal">0.00</span>
                    <span class="ai-label">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¬Ù„Ø³Ø©</span>
                </div>
                <div class="ai-stat-box">
                    <span class="ai-value" id="aiBestDay">-</span>
                    <span class="ai-label">Ø£ÙØ¶Ù„ ÙŠÙˆÙ… (Ø³Ø§Ø¨Ù‚)</span>
                </div>
            </div>

            <div class="performance-bar-container">
                <div class="perf-title">
                    <span>Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ</span>
                    <span id="compText">0%</span>
                </div>
                <div class="perf-progress-bg">
                    <div id="compBar" class="perf-progress-fill"></div>
                </div>
                <small id="compMessage" style="display:block; margin-top:5px; font-size:0.75rem; color:#666;"></small>
            </div>

            <h4 style="margin: 10px 0 5px 0; font-size: 0.9rem; color: #0277bd;">ğŸ“‹ Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h4>
            <ul class="ai-insights" id="aiInsightsList">
                <li>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</li>
            </ul>
        </div>
    </div>
    
    <hr>
    
    <button class="secondary-btn" onclick="showChartsModal()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</button>
    
    <hr>

    <h2>ğŸ“‘ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
    <table id="recordsTable">
        <thead>
            <tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø®Ø²Ø§Ù†</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø§Ù„ÙØ±Ù‚</th><th>Ø­Ø°Ù</th></tr>
        </thead>
        <tbody id="recordsBody"></tbody>
    </table>

    <hr>

    <div style="display: flex; gap: 10px;">
        <button class="danger-btn" onclick="endWork()" style="flex: 1;">ğŸ”´ Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­ÙØ¸ Ù„Ù„Ø£Ø±Ø´ÙŠÙ</button>
        <button class="secondary-btn" onclick="viewHistory()" style="flex: 1;">ğŸ“‚ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</button>
    </div>

    <div class="backup-section">
        <h3 style="margin-top: 0; font-size: 1rem;">ğŸ’¾ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="secondary-btn small-btn" onclick="exportData()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Backup</button>
            <input type="file" id="importFile" accept=".json" style="padding: 5px;" onchange="importData(this)">
        </div>
    </div>
</div>

<div id="chartsModal" class="charts-modal">
    <div class="charts-content">
        <h2 style="display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“ˆ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
            <button class="danger-btn small-btn" onclick="hideChartsModal()" style="margin: 0; width: auto;">Ø¥ØºÙ„Ø§Ù‚ âœ–ï¸</button>
        </h2>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="secondary-btn small-btn" onclick="renderAllCharts()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</button>
        </div>

        <div class="chart-container" style="height: 350px;">
            <h4>Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (T) - ÙƒÙ„ Ø®Ø²Ø§Ù†</h4>
            <canvas id="currentWeightsChart"></canvas>
        </div>

        <div class="chart-container" style="height: 350px;">
            <h4>ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø£ÙˆØ²Ø§Ù† (Ø·Ù†) - Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
            <canvas id="currentDifferencesChart"></canvas>
        </div>
        
        <div class="chart-container" style="height: 350px;">
            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ (T) - Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h4>
            <canvas id="historyTotalChart"></canvas>
        </div>
        
        <div class="chart-container" style="height: 350px;">
            <h4>Ù…ØªÙˆØ³Ø· Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (T/h) - Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h4>
            <canvas id="historySpeedChart"></canvas>
        </div>
    </div>
</div>

<div id="settingsModal" class="settings-modal">
    <div class="settings-content">
        <h2 style="display: flex; justify-content: space-between; align-items: center;">
            <span>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <button class="danger-btn small-btn" onclick="hideSettingsModal()" style="margin: 0; width: auto;">Ø¥ØºÙ„Ø§Ù‚ âœ–ï¸</button>
        </h2>
        
        <form id="settingsForm">
            <h3>ğŸ¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ØµØ±ÙŠ</h3>
            <label for="blinkSpeedInput">Ø³Ø±Ø¹Ø© ÙˆÙ…ÙŠØ¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø«Ø§Ù†ÙŠØ©):</label>
            <div class="input-group">
                <input type="number" id="blinkSpeedInput" min="0.1" max="2" step="0.1" required>
                <span>Ø«Ø§Ù†ÙŠØ©</span>
            </div>
            
            <label for="highWeightColorInput">Ù„ÙˆÙ† Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© (90% Ù…Ù† Ø§Ù„Ø³Ø¹Ø©):</label>
            <input type="color" id="highWeightColorInput" required>
            
            <label for="extensionColorInput">Ù„ÙˆÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø¯ÙŠØ¯ (ÙÙˆÙ‚ Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©):</label>
            <input type="color" id="extensionColorInput" required>

            <h3 style="margin-top: 30px;">ğŸ›¢ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø³Ø¹Ø§Øª</h3>
            <div id="siloSettingsContainer">
                </div>
            <button type="button" class="secondary-btn small-btn" onclick="addSiloSetting()" style="width: auto;">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø²Ø§Ù† Ø¬Ø¯ÙŠØ¯</button>
            <hr>
            
            <button type="submit" style="margin-top: 20px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§</button>
            <p id="settingsMessage" style="color: green; font-weight: bold; display: none; margin-top: 10px;">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.</p>
            
            <hr style="margin-top: 20px;">
            <h3 style="color: #dc3545;">âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹ (Format)</h3>
            <p style="font-size: 0.85rem; color: #6c757d;">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù **Ø¬Ù…ÙŠØ¹** Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŒ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù….</p>
            <button type="button" class="reset-btn" onclick="factoryReset()">ğŸ”¥ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </form>
    </div>
</div>

<div id="adminPage" class="container" style="display:none;">
    <h1>ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
    <div style="text-align: left; margin-bottom: 15px;">
        <span style="font-size: 0.8em; color: #666;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ <strong id="adminUser">Admin</strong></span>
        <button class="danger-btn small-btn" onclick="logout()" style="width: auto; margin-right: 10px;">Ø®Ø±ÙˆØ¬</button>
    </div>
    <hr>

    <h2>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h2>
    <p style="font-size: 0.8em; color: #999;">ØªÙ†Ø¨ÙŠÙ‡: ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙˆØ¶ÙˆØ­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ.</p>
    
    <table id="usersTable">
        <thead>
            <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr>
        </thead>
        <tbody id="usersBody">
            </tbody>
    </table>

    <button style="margin-top: 20px;" onclick="showAdminStats()" class="secondary-btn">Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© (Ù‚Ø±ÙŠØ¨Ø§Ù‹)</button>
</div>


<div id="historyPage" class="container" style="display:none;">
    <h2>ğŸ“‚ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ</h2>
    <div style="background:#e8f5e9; padding:10px; margin-bottom:15px; border-radius:5px; border:1px solid #c8e6c9;">
        <strong>ğŸ† Ø§Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„Ø´Ø±ÙÙŠØ©:</strong> Ø£ÙØ¶Ù„ Ø¥Ù†ØªØ§Ø¬ Ù…Ø³Ø¬Ù„ ÙƒØ§Ù† Ø¨ØªØ§Ø±ÙŠØ® <span id="bestDateDisplay"></span> Ø¨ÙƒÙ…ÙŠØ© <strong id="bestAmountDisplay"></strong> Ø·Ù†.
    </div>
    <table id="historyTable">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (T)</th><th>Ø§Ù„Ø³Ø±Ø¹Ø© (T/h)</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead> 
        <tbody id="historyBody"></tbody>
    </table>
    <button style="margin-top: 20px;" onclick="hideHistory()" class="secondary-btn">ğŸ”™ Ø¹ÙˆØ¯Ø©</button>
</div>

<div id="sessionDetailsModal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 12px;">
        <h3 style="margin-top:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
        <div id="modalAiSummary" class="ai-summary-box"></div> 
        
        <div style="max-height: 300px; overflow-y: auto;">
            <table id="modalRecordsTable">
                <thead>
                    <tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø®Ø²Ø§Ù†</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø§Ù„ÙØ±Ù‚</th></tr> 
                </thead>
                <tbody id="modalRecordsBody"></tbody>
            </table>
        </div>
        <button onclick="document.getElementById('sessionDetailsModal').style.display='none'" class="danger-btn small-btn" style="float: right; margin-top: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
        <div style="clear: both;"></div>
    </div>
</div>

<script>
    // ==========================================
    // âš™ï¸ Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Global Settings & Storage)
    // ==========================================
    
    const USERS_KEY = 'molinoUsers'; 
    const ADMIN_USER = 'admin'; 
    const ADMIN_PASS = '1234'; 
    const SETTINGS_KEY = 'molinoSettings'; 
    const CURRENT_SESSION_PREFIX = 'userSession_'; 
    const HISTORY_PREFIX = 'userHistory_';

    let AppSettings = {}; 
    let currentSessionRecords = []; 
    let lastKnownWeights = {}; 
    let currentAiAnalysis = {}; 
    let authMode = 'login'; 
    
    let currentWeightsChart = null;
    let currentDifferencesChart = null;
    let historyTotalChart = null;
    let historySpeedChart = null;
    
    const DEFAULT_CHART_COLORS = {
        'Siloun 1': 'rgba(54, 162, 235, 1)', 
        'Siloun 2': 'rgba(255, 99, 132, 1)', 
        'Siloun 3': 'rgba(75, 192, 192, 1)', 
        'Siloun 4': 'rgba(255, 159, 64, 1)', 
        'Good': 'rgba(40, 167, 69, 1)', 
        'Bad': 'rgba(220, 53, 69, 1)', 
    };

    const DEFAULT_SETTINGS = {
        BLINK_SPEED: 1.0, 
        HIGH_WEIGHT_COLOR: '#ffc107', 
        EXTENSION_COLOR: '#dc3545',   
        NORMAL_COLOR: '#28a745',      
        SILOS: [
            { id: 1, name: 'Siloun 1', ratedCapacity: 63.0, maxExtension: 75.0 },
            { id: 2, name: 'Siloun 2', ratedCapacity: 63.0, maxExtension: 75.0 },
            { id: 3, name: 'Siloun 3', ratedCapacity: 63.0, maxExtension: 75.0 },
            { id: 4, name: 'Siloun 4', ratedCapacity: 63.0, maxExtension: 75.0 }
        ],
    };

    // ==========================================
    // âš™ï¸ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Settings Functions)
    // ==========================================

    function loadSettings() {
        try {
            const storedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
            AppSettings = { ...DEFAULT_SETTINGS, ...storedSettings };
            AppSettings.SILOS = AppSettings.SILOS.map((s, i) => ({ ...s, id: s.id || (i + 1) }));
            applySettingsToUI();
        } catch (e) {
            AppSettings = DEFAULT_SETTINGS;
            applySettingsToUI();
        }
    }

    function saveSettings() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(AppSettings));
        applySettingsToUI();
    }

    function applySettingsToUI() {
        document.documentElement.style.setProperty('--blink-speed', `${AppSettings.BLINK_SPEED}s`);
        
        const maxOverallExtension = AppSettings.SILOS.reduce((max, s) => Math.max(max, s.maxExtension), 0);
        const maxWeightDisplay = document.getElementById('maxWeightDisplay');
        if (maxWeightDisplay) {
            maxWeightDisplay.textContent = `Max ${maxOverallExtension.toFixed(1)}T`;
        }
        
        updateSiloDropdown();
        setupGauges();
        updateAllGauges();
    }
    
    function updateSiloDropdown() {
        const select = document.getElementById('silounSelect');
        if (select) {
            select.innerHTML = AppSettings.SILOS.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            
            select.onchange = () => {
                const selectedSiloName = select.value;
                const selectedSilo = AppSettings.SILOS.find(s => s.name === selectedSiloName);
                if (selectedSilo) {
                     document.getElementById('weightInput').max = selectedSilo.maxExtension;
                     document.getElementById('maxWeightDisplay').textContent = `Max ${selectedSilo.maxExtension.toFixed(1)}T`;
                }
            };
            
            if(AppSettings.SILOS.length > 0) {
                 document.getElementById('weightInput').max = AppSettings.SILOS[0].maxExtension;
                 document.getElementById('maxWeightDisplay').textContent = `Max ${AppSettings.SILOS[0].maxExtension.toFixed(1)}T`;
            }
        }
    }

    function showSettingsModal() {
        document.getElementById('blinkSpeedInput').value = AppSettings.BLINK_SPEED;
        document.getElementById('highWeightColorInput').value = AppSettings.HIGH_WEIGHT_COLOR;
        document.getElementById('extensionColorInput').value = AppSettings.EXTENSION_COLOR;
        
        renderSiloSettings();

        document.getElementById('settingsModal').style.display = 'block';
        document.getElementById('settingsMessage').style.display = 'none';
    }

    function hideSettingsModal() {
        document.getElementById('settingsModal').style.display = 'none';
        setupGauges(); 
        updateAllGauges();
    }
    
    function renderSiloSettings() {
        const container = document.getElementById('siloSettingsContainer');
        container.innerHTML = AppSettings.SILOS.map((silo, index) => `
            <div class="silo-settings-row" id="silo-row-${silo.id}">
                <div class="silo-name-input">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø®Ø²Ø§Ù†:</label>
                    <input type="text" value="${silo.name}" id="silo-name-${silo.id}" required>
                </div>
                
                <div class="silo-capacity-input">
                    <label>Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø© (T):</label>
                    <input type="number" value="${silo.ratedCapacity.toFixed(1)}" min="1" step="0.1" id="silo-rated-${silo.id}" required>
                </div>
                
                <div class="silo-capacity-input">
                    <label>Ø£Ù‚ØµÙ‰ ØªÙ…Ø¯ÙŠØ¯ (T):</label>
                    <input type="number" value="${silo.maxExtension.toFixed(1)}" min="1" step="0.1" id="silo-max-${silo.id}" required>
                </div>

                <button class="danger-btn small-btn" type="button" onclick="removeSiloSetting(${silo.id})" style="flex: 0 0 50px;">âŒ</button>
            </div>
        `).join('');
    }

    function addSiloSetting() {
        const newId = AppSettings.SILOS.reduce((max, s) => Math.max(max, s.id), 0) + 1;
        AppSettings.SILOS.push({ 
            id: newId, 
            name: `Ø®Ø²Ø§Ù† Ø¬Ø¯ÙŠØ¯ ${newId}`, 
            ratedCapacity: 63.0, 
            maxExtension: 75.0 
        });
        renderSiloSettings();
    }

    function removeSiloSetting(id) {
        if (AppSettings.SILOS.length <= 1) {
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ø£Ø®ÙŠØ±!");
            return;
        }
        
        const siloToRemove = AppSettings.SILOS.find(s => s.id === id);
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø®Ø²Ø§Ù† ${siloToRemove.name}ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙ‚Ø· ÙˆÙ„ÙŠØ³ Ø³Ø¬Ù„Ø§ØªÙ‡ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©.`)) {
            AppSettings.SILOS = AppSettings.SILOS.filter(s => s.id !== id);
            renderSiloSettings();
        }
    }
    
    document.getElementById('settingsForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const newBlinkSpeed = parseFloat(document.getElementById('blinkSpeedInput').value);
        const newHighColor = document.getElementById('highWeightColorInput').value;
        const newExtensionColor = document.getElementById('extensionColorInput').value;

        const newSilos = [];
        let isValid = true;

        AppSettings.SILOS.forEach(silo => {
            const nameInput = document.getElementById(`silo-name-${silo.id}`);
            const ratedInput = document.getElementById(`silo-rated-${silo.id}`);
            const maxInput = document.getElementById(`silo-max-${silo.id}`);
            
            const newName = nameInput ? nameInput.value.trim() : silo.name;
            const newRated = parseFloat(ratedInput ? ratedInput.value : silo.ratedCapacity);
            const newMax = parseFloat(maxInput ? maxInput.value : silo.maxExtension);

            if (newName === '' || isNaN(newRated) || isNaN(newMax)) {
                 alert(`Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† ${silo.id}.`);
                 isValid = false;
                 return;
            }
            if (newRated >= newMax) {
                alert(`Ø®Ø·Ø£: ÙÙŠ Ø§Ù„Ø®Ø²Ø§Ù† "${newName}"ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªÙ…Ø¯ÙŠØ¯ (${newMax}T) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø© (${newRated}T).`);
                isValid = false;
                return;
            }
            
            newSilos.push({ id: silo.id, name: newName, ratedCapacity: newRated, maxExtension: newMax });
        });

        if (!isValid || newSilos.length === 0) {
            if(newSilos.length === 0 && isValid) alert('âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ø®Ø²Ø§Ù† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }

        AppSettings.BLINK_SPEED = newBlinkSpeed;
        AppSettings.HIGH_WEIGHT_COLOR = newHighColor;
        AppSettings.EXTENSION_COLOR = newExtensionColor;
        AppSettings.SILOS = newSilos;
        
        saveSettings();
        
        document.getElementById('settingsMessage').style.display = 'block';
        setTimeout(() => { 
            document.getElementById('settingsMessage').style.display = 'none'; 
            applySettingsToUI();
        }, 3000);
    });

    function getSiloSettings(name) {
        return AppSettings.SILOS.find(s => s.name === name);
    }


    // ==========================================
    // ğŸ” ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication)
    // ==========================================
    
    function checkAuth() {
        const currentUser = localStorage.getItem('currentUser');
        hideAllPages();
        if (currentUser) {
            if (currentUser === ADMIN_USER) {
                document.getElementById('adminPage').style.display = 'block';
                renderUsersTable(); 
            } else {
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('loggedInUser').textContent = currentUser;
                loadInitialData(); 
            }
        } else {
            document.getElementById('auth-page').style.display = 'flex';
        }
    }
    
    function hideAllPages() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('adminPage').style.display = 'none';
        document.getElementById('historyPage').style.display = 'none';
        document.getElementById('sessionDetailsModal').style.display = 'none';
        document.getElementById('chartsModal').style.display = 'none';
        document.getElementById('settingsModal').style.display = 'none'; 
    }

    function getUsers() {
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        users[ADMIN_USER] = ADMIN_PASS; 
        return users;
    }

    function getCurrentUserKey() {
        return localStorage.getItem('currentUser');
    }

    function toggleAuthMode() {
        const title = document.getElementById('auth-title');
        const button = document.getElementById('authButton');
        const link = document.getElementById('toggleAuth');
        const message = document.getElementById('authMessage');

        if (authMode === 'login') {
            authMode = 'register';
            title.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ âœ¨';
            button.textContent = 'ØªØ³Ø¬ÙŠÙ„';
            link.textContent = 'Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ (ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„)';
        } else {
            authMode = 'login';
            title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ‘‹';
            button.textContent = 'Ø¯Ø®ÙˆÙ„';
            link.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
        }
        message.style.display = 'none';
    }

    document.getElementById('authForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('usernameInput').value.trim();
        const password = document.getElementById('passwordInput').value.trim();
        const users = getUsers();
        const message = document.getElementById('authMessage');

        message.style.display = 'none';

        if (authMode === 'register') {
            if (username === ADMIN_USER) {
                message.textContent = 'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø­Ø¬ÙˆØ² Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©.';
                message.style.display = 'block';
                return;
            }
            
            if (users[username]) {
                message.textContent = 'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.';
                message.style.display = 'block';
            } else if (username.length < 3 || password.length < 3) {
                message.textContent = 'âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
                message.style.display = 'block';
            } else {
                let existingUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
                existingUsers[username] = password; 
                localStorage.setItem(USERS_KEY, JSON.stringify(existingUsers));

                message.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
                message.style.display = 'block';
                toggleAuthMode(); 
            }
        } else {
            if (users[username] === password) {
                localStorage.setItem('currentUser', username);
                checkAuth(); 
            } else {
                message.textContent = 'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                message.style.display = 'block';
            }
        }
    });

    function logout() {
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
            localStorage.removeItem('currentUser');
            checkAuth(); 
        }
    }
    
    // ==========================================
    // ğŸ‘‘ ÙˆØ¸Ø§Ø¦Ù Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin Functions)
    // ==========================================

    function renderUsersTable() {
        const users = getUsers();
        const tb = document.getElementById('usersBody');
        tb.innerHTML = '';
        
        for (const [username, password] of Object.entries(users)) {
            const isDeletable = username !== ADMIN_USER;
            const options = isDeletable ? 
                `<button class="danger-btn small-btn" onclick="deleteUser('${username}')">âŒ Ø­Ø°Ù</button>` : 
                `<span style="color: #6c757d; font-size: 0.8em;">Ø­Ø³Ø§Ø¨ Ø¥Ø¯Ø§Ø±ÙŠ</span>`;

            tb.innerHTML += `
                <tr>
                    <td>${username}</td>
                    <td>${password}</td>
                    <td>${options}</td>
                </tr>
            `;
        }
    }

    function deleteUser(username) {
        if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ`)) return;

        let users = getUsers();
        delete users[username];
        
        const { [ADMIN_USER]: adminPass, ...otherUsers } = users;
        localStorage.setItem(USERS_KEY, JSON.stringify(otherUsers));

        localStorage.removeItem(CURRENT_SESSION_PREFIX + username);
        localStorage.removeItem(HISTORY_PREFIX + username);
        
        alert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} Ø¨Ù†Ø¬Ø§Ø­.`);
        renderUsersTable(); 
    }
    
    function showAdminStats() {
        alert('Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±!');
    }

    // ==========================================
    // ğŸ“¦ ÙˆØ¸Ø§Ø¦Ù Ø¹Ø²Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Isolation Functions)
    // ==========================================

    function loadUserSessionData() {
        const user = getCurrentUserKey();
        if (!user) return;

        const stored = localStorage.getItem(CURRENT_SESSION_PREFIX + user);
        currentSessionRecords = stored ? JSON.parse(stored) : [];

        lastKnownWeights = {}; 
        AppSettings.SILOS.map(s => s.name).forEach(siloName => {
            const recs = currentSessionRecords
                .filter(r => r.siloun === siloName)
                .sort((a,b) => a.id - b.id); 
            lastKnownWeights[siloName] = recs.length ? parseFloat(recs[recs.length-1].weight) : 0;
        });
    }

    function saveUserSessionData() {
        const user = getCurrentUserKey();
        if (user) {
            localStorage.setItem(CURRENT_SESSION_PREFIX + user, JSON.stringify(currentSessionRecords));
        }
    }
    
    function loadUserHistory() {
        const user = getCurrentUserKey();
        if (!user) return [];
        return JSON.parse(localStorage.getItem(HISTORY_PREFIX + user) || '[]');
    }

    function saveUserHistory(historyData) {
        const user = getCurrentUserKey();
        if (user) {
            localStorage.setItem(HISTORY_PREFIX + user, JSON.stringify(historyData));
        }
    }

    // ==========================================
    // ğŸ—ï¸ Ø¨Ø§Ù‚ÙŠ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App Functions)
    // ==========================================

    // --- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ---
    document.addEventListener('DOMContentLoaded', () => {
        loadSettings(); 
        checkAuth(); 
        updateDateTime();
        
        // PWA: Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù„Ù Ù†ÙØ³Ù‡ ÙƒÙ€ Service Worker Ø¨Ù…Ø§ Ø£Ù†Ù‡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ÙƒÙˆØ¯
                // ÙˆÙ†Ø¶ÙŠÙÙ‡ ÙƒÙ…Ù„Ù Ù…Ù†ÙØµÙ„ "sw.js" ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø®Ø§Ø¯Ù…. 
                // Ù„ÙƒÙ† Ù„ØªØ³Ù‡ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ Ø¨Ø³ÙŠØ· ÙŠÙÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯Ù‡ (sw.js)
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ØªÙˆÙØ±Ù‹Ø§ØŒ Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒØµÙØ­Ø© ÙˆÙŠØ¨ Ø¹Ø§Ø¯ÙŠØ©.

                // *************************************************************
                // ØªÙ†Ø¨ÙŠÙ‡: ÙÙŠ Ø¨ÙŠØ¦Ø© PWA Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† sw.js Ù…Ù„ÙÙ‹Ø§ Ù…Ù†ÙØµÙ„Ù‹Ø§!
                // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ù…Ù„ÙÙ‹Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ù„ØªØ³Ø¬ÙŠÙ„ PWA.
                // *************************************************************
                
                // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ø§Ù†Ø´Ø§Ø¡ sw.js Ù…Ù†ÙØµÙ„ØŒ Ù†Ø¹ØªØ¨Ø± Ø£Ù† Ù…Ù„Ù sw.js Ø§Ù„ØªØ§Ù„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯:
                navigator.serviceWorker.register('./sw.js')
                  .then(reg => console.log('Service Worker registered: ', reg))
                  .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
        
    });

    function formatDateTimeEnglish(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleString('en-GB', { hour12: false }).replace(',', '');
    }
    
    function formatDateOnly(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleDateString('en-GB');
    }

    function updateDateTime() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        document.getElementById('dateTimeInput').value = new Date(now.getTime() - offset).toISOString().slice(0, 16);
    }

    function loadInitialData() {
        loadUserSessionData(); 
        updateAllGauges();
        renderRecords();
        performSmartAIAnalysis(); 
    }

    function setupGauges() {
        document.getElementById('gauges').innerHTML = AppSettings.SILOS.map(silo => {
            const RATED_CAPACITY = silo.ratedCapacity;
            const MAX_EXTENSION = silo.maxExtension;
            const siloName = silo.name;
            const id = siloName.replace(/\s/g,'');
            
            return `
                <div class="gauge-container">
                    <div class="gauge-labels">
                        <strong>${siloName}</strong>
                        <strong style="font-family:sans-serif;"><span id="w-${id}">0.00</span> T</strong>
                    </div>
                    <div class="gauge-wrapper">
                        <div class="gauge-main"><div id="bar-m-${id}" class="fill-bar" style="background:${AppSettings.NORMAL_COLOR};"></div></div>
                        <div class="gauge-extension"><div id="bar-e-${id}" class="fill-bar" style="background:${AppSettings.EXTENSION_COLOR};"></div></div>
                    </div>
                    <div class="gauge-sub-labels"><span>0</span><span style="margin-right:-15%">${RATED_CAPACITY.toFixed(1)}</span><span>${MAX_EXTENSION.toFixed(1)}</span></div>
                </div>
            `;
        }).join('');
    }

    function updateGauge(siloName, weight) {
        const siloSettings = getSiloSettings(siloName);
        if (!siloSettings) return;

        const RATED_CAPACITY = siloSettings.ratedCapacity;
        const MAX_EXTENSION = siloSettings.maxExtension;

        const id = siloName.replace(/\s/g,'');
        const w = typeof weight === 'string' ? parseFloat(weight) : weight; 

        const wDisplay = document.getElementById(`w-${id}`);
        const mBar = document.getElementById(`bar-m-${id}`);
        const eBar = document.getElementById(`bar-e-${id}`);
        
        if (!wDisplay || !mBar || !eBar) return; 

        wDisplay.textContent = w.toFixed(2);

        if (w <= RATED_CAPACITY) {
            mBar.style.width = `${(w/RATED_CAPACITY)*100}%`;
            eBar.style.width = '0%';
            mBar.style.backgroundColor = w >= (RATED_CAPACITY * 0.9) ? AppSettings.HIGH_WEIGHT_COLOR : AppSettings.NORMAL_COLOR;
            eBar.textContent = "";
            eBar.classList.remove('blinking');
        } else {
            mBar.style.width = '100%';
            mBar.style.backgroundColor = AppSettings.HIGH_WEIGHT_COLOR; 
            
            const extensionRange = MAX_EXTENSION - RATED_CAPACITY;
            const extendedWeight = w - RATED_CAPACITY;
            
            const extP = (extendedWeight / extensionRange) * 100;
            
            eBar.style.width = `${Math.min(extP, 100)}%`;
            eBar.textContent = "EXT";
            eBar.style.backgroundColor = AppSettings.EXTENSION_COLOR;
            
            if (w >= MAX_EXTENSION) {
                 eBar.classList.add('blinking');
            } else {
                 eBar.classList.remove('blinking');
            }
        }
    }

    function updateAllGauges() { 
        AppSettings.SILOS.map(s => s.name).forEach(s => updateGauge(s, lastKnownWeights[s]||0)); 
    }
    
    document.getElementById('entryForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const s = document.getElementById('silounSelect').value;
        const w = parseFloat(document.getElementById('weightInput').value);
        const dt = document.getElementById('dateTimeInput').value;
        const newTime = new Date(dt).getTime();
        
        const siloSettings = getSiloSettings(s);
        if (!siloSettings) return alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù†.');

        if (w > siloSettings.maxExtension) return alert(`Ø®Ø·Ø£: Ø§Ù„ÙˆØ²Ù† ÙŠØªØ¬Ø§ÙˆØ² ${siloSettings.maxExtension.toFixed(1)} Ø·Ù† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø®Ø²Ø§Ù†!`);

        if (currentSessionRecords.length > 0) {
            const sortedRecords = [...currentSessionRecords].sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
            const lastRecordedTime = new Date(sortedRecords[0].dateTime).getTime();
            if (newTime < lastRecordedTime) {
                alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠ: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø³Ø§Ø¨Ù‚Ø© Ù„ÙˆÙ‚Øª Ø¢Ø®Ø± Ø³Ø¬Ù„ (${formatDateTimeEnglish(sortedRecords[0].dateTime)})`);
                return; 
            }
        }
        
        const prev = lastKnownWeights[s] || 0;
        let diff = 'Ø¨Ø¯Ø§ÙŠØ©';
        
        if (currentSessionRecords.filter(r=>r.siloun === s).length > 0 || prev > 0) {
             diff = (w - prev).toFixed(2);
        }

        currentSessionRecords.push({ id: Date.now(), dateTime: dt, siloun: s, weight: w.toFixed(2), difference: diff });
        
        lastKnownWeights[s] = w;
        saveUserSessionData(); 
        
        renderRecords();
        updateGauge(s, w);
        performSmartAIAnalysis(); 
        
        document.getElementById('weightInput').value = '';
        updateDateTime();
    });

    function deleteRecord(id) {
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
        
        const idx = currentSessionRecords.findIndex(r=>r.id===id);
        if(idx===-1) return;
        const silo = currentSessionRecords[idx].siloun;
        currentSessionRecords.splice(idx,1);
        
        let siloRecs = currentSessionRecords
            .filter(r=>r.siloun===silo)
            .sort((a,b)=>a.id - b.id); 

        
        siloRecs.forEach((r,i) => {
            if(i === 0) {
                r.difference = 'Ø¨Ø¯Ø§ÙŠØ©';
            } else {
                const prevWeight = parseFloat(siloRecs[i - 1].weight);
                r.difference = (parseFloat(r.weight) - prevWeight).toFixed(2);
            }
        });
        
        lastKnownWeights[silo] = siloRecs.length ? parseFloat(siloRecs[siloRecs.length-1].weight) : 0;
        
        saveUserSessionData();
        
        renderRecords();
        updateAllGauges();
        performSmartAIAnalysis();
    }

    function renderRecords() {
        const tb = document.getElementById('recordsBody');
        tb.innerHTML = '';
        [...currentSessionRecords].reverse().forEach(r => {
            const diffColor = parseFloat(r.difference) > 0 ? 'green' : (parseFloat(r.difference) < 0 ? 'red' : 'inherit');
            tb.innerHTML += `<tr>
                <td>${formatDateTimeEnglish(r.dateTime)}</td>
                <td>${r.siloun}</td>
                <td>${r.weight}</td>
                <td style="color:${diffColor}">${r.difference}</td>
                <td><button class="danger-btn small-btn" onclick="deleteRecord(${r.id})">âŒ</button></td>
            </tr>`;
        });
    }

    function performSmartAIAnalysis() {
        
        const insightsList = document.getElementById('aiInsightsList');
        const aiSpeed = document.getElementById('aiSpeed');
        const aiTotal = document.getElementById('aiTotal');
        const aiBestDay = document.getElementById('aiBestDay');
        const compBar = document.getElementById('compBar');
        const compText = document.getElementById('compText');
        const compMessage = document.getElementById('compMessage');
        const liveStatus = document.getElementById('liveStatus');

        if (currentSessionRecords.length === 0) {
            aiSpeed.textContent = "0.0";
            aiTotal.textContent = "0.00";
            liveStatus.textContent = "Ø¨Ø¯Ø§ÙŠØ© ğŸ’¤";
            liveStatus.style.background = "#999";
            liveStatus.style.color = "white";
            insightsList.innerHTML = '<li>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</li>';
            compBar.style.width = '0%';
            compText.textContent = '0%';
            compMessage.textContent = 'Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©.';
            return;
        }

        insightsList.innerHTML = '';
        let insights = [];
        let totalDurationHrs = 0;
        let finalSpeed = 0;
        let lastUpdateTime = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

        let totalCurrent = 0;
        currentSessionRecords.forEach(r => {
            const v = parseFloat(r.difference);
            if(v > 0) totalCurrent += v; 
        });
        aiTotal.textContent = totalCurrent.toFixed(2);

        const history = loadUserHistory();
        let maxHistTotal = 0;
        let bestDateStr = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        let histTotals = [];
        
        history.forEach(h => {
            const t = parseFloat(h.total);
            histTotals.push(t);
            if(t > maxHistTotal) {
                maxHistTotal = t;
                bestDateStr = formatDateOnly(h.date); 
            }
        });
        aiBestDay.textContent = maxHistTotal > 0 ? `${maxHistTotal} (${bestDateStr})` : '-';

        if (currentSessionRecords.length > 1) {
            const sorted = [...currentSessionRecords].sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
            const startTime = new Date(sorted[0].dateTime);
            const endTime = new Date(sorted[sorted.length-1].dateTime);
            totalDurationHrs = (endTime - startTime) / 3600000; 
            lastUpdateTime = formatDateTimeEnglish(endTime.toISOString());
            
            if (totalDurationHrs > 0.1) { 
                finalSpeed = totalCurrent / totalDurationHrs;
                aiSpeed.textContent = finalSpeed.toFixed(1);
                liveStatus.textContent = "ÙŠØ¹Ù…Ù„ âš¡";
                liveStatus.style.background = "#4caf50";
                liveStatus.style.color = "white";
            } else {
                liveStatus.textContent = "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„...";
            }

            if (histTotals.length > 0) {
                const avgHist = histTotals.reduce((a,b)=>a+b,0) / histTotals.length;
                const performanceRatio = (totalCurrent / (avgHist || 1)) * 100;
                let width = Math.min(performanceRatio, 100);
                
                compBar.style.width = `${width}%`;
                compText.textContent = `${performanceRatio.toFixed(0)}%`;
                
                if (performanceRatio > 110) {
                    compBar.style.background = "#28a745"; 
                    compMessage.textContent = "ğŸš€ Ø£Ø¯Ø§Ø¡ Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ! Ø£Ù†Øª ØªØªÙÙˆÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªÙˆØ³Ø·.";
                    insights.push("ğŸŒŸ **Ø¹Ù…Ù„ Ù…Ù…ØªØ§Ø²:** Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø¹ØªØ§Ø¯.");
                } else if (performanceRatio > 80) {
                    compBar.style.background = "#17a2b8"; 
                    compMessage.textContent = "âœ… Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ ÙˆÙ…Ø³ØªÙ‚Ø±.";
                } else {
                    compBar.style.background = "#ffc107"; 
                    compMessage.textContent = "ğŸ“‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
                    insights.push("âš ï¸ **ØªØ­Ø°ÙŠØ±:** Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¨Ù†Ø³Ø¨Ø© ÙƒØ¨ÙŠØ±Ø©. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø­Ù†.");
                }
            } else {
                compMessage.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ© ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©.";
            }

            const lastRec = sorted[sorted.length-1];
            const prevRec = sorted[sorted.length-2];
            
            const lastSiloSettings = getSiloSettings(lastRec.siloun);
            if (lastSiloSettings && lastRec.siloun === prevRec.siloun) {
                const RATED_CAPACITY = lastSiloSettings.ratedCapacity;
                const timeDiff = (new Date(lastRec.dateTime) - new Date(prevRec.dateTime)) / 3600000;
                const weightDiff = parseFloat(lastRec.weight) - parseFloat(prevRec.weight);
                
                if (timeDiff > 0 && weightDiff > 0.5) { 
                    const currentRate = weightDiff / timeDiff; 
                    const currentW = parseFloat(lastRec.weight);
                    
                    if (currentRate > 1) { 
                        const remainingToCapacity = RATED_CAPACITY - currentW;
                        if (remainingToCapacity > 0) {
                            const hoursLeft = remainingToCapacity / currentRate;
                            const fullTime = new Date(endTime.getTime() + (hoursLeft * 3600000));
                            insights.push(`â±ï¸ **ØªÙˆÙ‚Ø¹:** Ø³ÙŠÙ…ØªÙ„Ø¦ ${lastRec.siloun} (${RATED_CAPACITY.toFixed(1)}T) Ø­ÙˆØ§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© ${fullTime.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}.`);
                        }
                    }
                }
            }

            const minutesSinceLast = (new Date() - endTime) / 60000;
            if (minutesSinceLast > 45) {
                insights.push(`âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡:** Ø§Ù„Ø·Ø­Ù† Ù…ØªÙˆÙ‚Ù Ù…Ù†Ø° ${minutesSinceLast.toFixed(0)} Ø¯Ù‚ÙŠÙ‚Ø©.`);
                liveStatus.textContent = "Ù…ØªÙˆÙ‚Ù ğŸ’¤";
                liveStatus.style.background = "#dc3545"; 
            } else if (minutesSinceLast > 15) {
                insights.push(`â³ **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù†Ø° ${minutesSinceLast.toFixed(0)} Ø¯Ù‚ÙŠÙ‚Ø©.`);
            }

        } else {
            insights.push("â„¹ï¸ Ø£Ø¯Ø®Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø«Ø§Ù†ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„ØªÙˆÙ‚Ø¹Ø§Øª.");
        }

        // ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„Ø³Ø¹Ø§Øª
        AppSettings.SILOS.forEach(silo => {
            const w = lastKnownWeights[silo.name] || 0;
            const RATED_CAPACITY = silo.ratedCapacity;
            const MAX_EXTENSION = silo.maxExtension;
            
            if (w >= MAX_EXTENSION) {
                 insights.push(`ğŸ›‘ **Ø®Ø·Ø± Ø§Ù…ØªÙ„Ø§Ø¡:** ${silo.name} ÙˆØµÙ„ Ø¥Ù„Ù‰ Ø£Ù‚ØµÙ‰ Ø­Ø¯ Ù„Ù„ØªÙ…Ø¯ÙŠØ¯ (${w.toFixed(2)}T)!`);
            } else if (w > RATED_CAPACITY) {
                insights.push(`ğŸš¨ **ØªØ­Ø°ÙŠØ±:** ${silo.name} ÙŠØ¹Ù…Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø¯ÙŠØ¯ (${w.toFixed(2)}T)! ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©.`);
            } else if (w >= (RATED_CAPACITY * 0.9)) {
                insights.push(`ğŸ”” **ØªÙ†Ø¨ÙŠÙ‡:** ${silo.name} Ø§Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø§Ù…ØªÙ„Ø§Ø¡ Ø§Ù„Ø±Ø³Ù…ÙŠ (${w.toFixed(2)}/${RATED_CAPACITY.toFixed(1)}).`);
            }
        });

        currentAiAnalysis = {
            total: totalCurrent.toFixed(2),
            speed: finalSpeed.toFixed(1),
            duration: totalDurationHrs.toFixed(2),
            insights: insights.map(i => i.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')),
            lastUpdate: lastUpdateTime
        };

        if (insights.length === 0) insights.push("âœ… Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø·Ø¨ÙŠØ¹ÙŠØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©.");
        insightsList.innerHTML = insights.map(i => `<li>${i.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</li>`).join('');
    }
    
    // ==========================================
    // ğŸ“Š ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© (Chart Functions)
    // ==========================================

    function showChartsModal() {
        document.getElementById('chartsModal').style.display = 'block';
        renderAllCharts(); 
    }
    
    function hideChartsModal() {
        document.getElementById('chartsModal').style.display = 'none';
        destroyAllCharts(); 
    }

    function destroyAllCharts() {
        if (currentWeightsChart) { currentWeightsChart.destroy(); currentWeightsChart = null; }
        if (currentDifferencesChart) { currentDifferencesChart.destroy(); currentDifferencesChart = null; }
        if (historyTotalChart) { historyTotalChart.destroy(); historyTotalChart = null; }
        if (historySpeedChart) { historySpeedChart.destroy(); historySpeedChart = null; }
    }

    function renderAllCharts() {
        destroyAllCharts(); 
        renderCurrentWeightsChart();
        renderCurrentDifferencesChart();
        renderHistoryTotalChart();
        renderHistorySpeedChart();
    }

    function renderCurrentWeightsChart() {
        const sortedRecords = [...currentSessionRecords].sort((a,b) => a.id - b.id);
        const allLabels = sortedRecords.map(r => formatDateTimeEnglish(r.dateTime).split(' ')[1]);
        
        const colors = ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 159, 64, 1)'];
        let colorIndex = 0;
        
        const datasets = AppSettings.SILOS.map(silo => {
            const color = colors[colorIndex++ % colors.length];
            return {
                label: silo.name,
                data: sortedRecords.map(r => r.siloun === silo.name ? parseFloat(r.weight) : NaN), 
                borderColor: color,
                backgroundColor: color.replace('1)', '0.5)'),
                borderWidth: 2,
                fill: false,
                spanGaps: true, 
            };
        });

        const maxOverallExtension = AppSettings.SILOS.reduce((max, s) => Math.max(max, s.maxExtension), 0);

        const ctx = document.getElementById('currentWeightsChart').getContext('2d');
        currentWeightsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: datasets.filter(d => d.data.some(v => !isNaN(v))) 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top', rtl: true, }, title: { display: false } },
                scales: {
                    y: { 
                        min: 0, 
                        max: maxOverallExtension + 5, 
                        title: { display: true, text: 'Ø§Ù„ÙˆØ²Ù† (T)' },
                        ticks: { callback: function(value) { return value + ' T'; } }
                    },
                    x: { title: { display: true, text: 'Ø§Ù„ÙˆÙ‚Øª (Ø§Ù„Ø³Ø§Ø¹Ø©:Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©)' }}
                }
            }
        });
    }

    function renderCurrentDifferencesChart() {
        const sortedRecords = [...currentSessionRecords].sort((a,b) => a.id - b.id);
        
        const labels = sortedRecords.map(r => `${formatDateTimeEnglish(r.dateTime).split(' ')[1]} (${r.siloun.replace('Siloun ','S')})`); 
        const data = sortedRecords.map(r => parseFloat(r.difference));
        const backgroundColors = sortedRecords.map(r => {
            const diff = parseFloat(r.difference);
            return diff > 0 ? DEFAULT_CHART_COLORS.Good.replace('1)', '0.7)') : 
                   (diff < 0 ? DEFAULT_CHART_COLORS.Bad.replace('1)', '0.7)') : 
                    '#ccc');
        });
        
        const filteredLabels = labels.filter((_, i) => sortedRecords[i].difference !== 'Ø¨Ø¯Ø§ÙŠØ©');
        const filteredData = data.filter((_, i) => sortedRecords[i].difference !== 'Ø¨Ø¯Ø§ÙŠØ©');
        const filteredColors = backgroundColors.filter((_, i) => sortedRecords[i].difference !== 'Ø¨Ø¯Ø§ÙŠØ©');


        const ctx = document.getElementById('currentDifferencesChart').getContext('2d');
        currentDifferencesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: filteredLabels,
                datasets: [{
                    label: 'ÙØ±Ù‚ Ø§Ù„ÙˆØ²Ù† (Ø·Ù†)',
                    data: filteredData,
                    backgroundColor: filteredColors,
                    borderColor: filteredColors.map(c => c.replace('0.7)', '1)')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: false } },
                scales: {
                    y: { title: { display: true, text: 'Ø§Ù„ÙØ±Ù‚ (T)' } },
                    x: { title: { display: true, text: 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„' }}
                }
            }
        });
    }
    
    function renderHistoryTotalChart() {
        const history = loadUserHistory().sort((a,b) => new Date(a.date) - new Date(b.date));

        const labels = history.map(h => formatDateOnly(h.date));
        const data = history.map(h => parseFloat(h.total));
        
        const ctx = document.getElementById('historyTotalChart').getContext('2d');
        historyTotalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (T)',
                    data: data,
                    borderColor: DEFAULT_CHART_COLORS.Good,
                    backgroundColor: DEFAULT_CHART_COLORS.Good.replace('1)', '0.2)'),
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: false } },
                scales: {
                    y: { min: 0, title: { display: true, text: 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (T)' } },
                    x: { title: { display: true, text: 'Ø§Ù„ØªØ§Ø±ÙŠØ®' }}
                }
            }
        });
    }

    function renderHistorySpeedChart() {
        const history = loadUserHistory().sort((a,b) => new Date(a.date) - new Date(b.date));

        const labels = history.map(h => formatDateOnly(h.date));
        const data = history.map(h => parseFloat(h.speed));
        
        const ctx = document.getElementById('historySpeedChart').getContext('2d');
        historySpeedChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø© (T/h)',
                    data: data,
                    backgroundColor: DEFAULT_CHART_COLORS['Siloun 1'].replace('1)', '0.7)'),
                    borderColor: DEFAULT_CHART_COLORS['Siloun 1'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: false } },
                scales: {
                    y: { min: 0, title: { display: true, text: 'Ø§Ù„Ø³Ø±Ø¹Ø© (T/h)' } },
                    x: { title: { display: true, text: 'Ø§Ù„ØªØ§Ø±ÙŠØ®' }}
                }
            }
        });
    }


    // ==========================================
    // ğŸ’¾ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ø¥Ù†Ù‡Ø§Ø¡ (Data/Work Control)
    // ==========================================

    function exportData() {
        const d = { 
            s: localStorage.getItem(CURRENT_SESSION_PREFIX + getCurrentUserKey()) || '[]', 
            h: localStorage.getItem(HISTORY_PREFIX + getCurrentUserKey()) || '[]',
            u: getUsers(),
            settings: localStorage.getItem(SETTINGS_KEY) || JSON.stringify(DEFAULT_SETTINGS) 
        };
        const blob = new Blob([JSON.stringify(d)], {type:"application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "Silo_AI_Backup_" + getCurrentUserKey() + "_" + new Date().toISOString().slice(0,10) + ".json";
        a.click();
    }

    function importData(inp) {
        const f = inp.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                const currentUser = getCurrentUserKey();
                
                if(confirm("âš ï¸ Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ³ØªÙˆØ±Ø¯Ø© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                    
                    if(d.settings) {
                        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙØ³ØªÙˆØ±Ø¯Ø©ØŸ")) {
                            localStorage.setItem(SETTINGS_KEY, d.settings);
                        }
                    }

                    if(d.s) {
                        let currentS = currentSessionRecords;
                        const importedS = JSON.parse(d.s);
                        const existingIds = new Set(currentS.map(rec => rec.id));
                        const newRecords = importedS.filter(rec => !existingIds.has(rec.id));
                        currentSessionRecords = currentS.concat(newRecords);
                        saveUserSessionData(); 
                    }

                    if(d.h) {
                        let currentH = loadUserHistory();
                        const importedH = JSON.parse(d.h);
                        const existingDates = new Set(currentH.map(hist => new Date(hist.date).toLocaleDateString())); 
                        
                        const newHistory = importedH.filter(hist => !existingDates.has(new Date(hist.date).toLocaleDateString()));
                        currentH = currentH.concat(newHistory);
                        saveUserHistory(currentH); 
                    }
                    
                    if(d.u) {
                        let existingUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
                        const { [ADMIN_USER]: adminPass, ...otherUsers } = existingUsers; 
                        
                        const importedUsers = d.u;
                        const mergedUsers = {...otherUsers};
                        for(const [u, p] of Object.entries(importedUsers)) {
                            if (u !== ADMIN_USER && !mergedUsers[u]) {
                                mergedUsers[u] = p;
                            }
                        }
                        localStorage.setItem(USERS_KEY, JSON.stringify(mergedUsers)); 
                    }

                    alert("âœ… ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
                    location.reload();
                }
            } catch(x) { 
                alert("âŒ Ø®Ø·Ø£: Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­."); 
                console.error(x);
            }
        };
        r.readAsText(f);
    }

    function factoryReset() {
        if(confirm("âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!")) {
            localStorage.clear();
            alert("ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
            location.reload();
        }
    }

    function endWork() {
        if(currentSessionRecords.length===0) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ³Ø¬ÙŠÙ„Ù‡Ø§.');
        if(!confirm('Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ­ÙØ¸Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ')) return;
        
        performSmartAIAnalysis(); 

        const h = loadUserHistory();
        h.push({ date: new Date(), 
                 total: currentAiAnalysis.total, 
                 speed: currentAiAnalysis.speed, 
                 duration: currentAiAnalysis.duration, 
                 aiReport: currentAiAnalysis.insights, 
                 records: currentSessionRecords 
               });
        saveUserHistory(h);
        
        localStorage.removeItem(CURRENT_SESSION_PREFIX + getCurrentUserKey());
        location.reload();
    }

    function viewHistory() {
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('historyPage').style.display = 'block';
        
        const h = loadUserHistory();
        if(h.length > 0) {
            let maxRec = h.reduce((p, c) => (parseFloat(p.total) > parseFloat(c.total)) ? p : c);
            document.getElementById('bestDateDisplay').textContent = formatDateOnly(maxRec.date);
            document.getElementById('bestAmountDisplay').textContent = maxRec.total;
        } else {
             document.getElementById('bestDateDisplay').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
             document.getElementById('bestAmountDisplay').textContent = '0.00';
        }

        const tb = document.getElementById('historyBody');
        tb.innerHTML = '';
        [...h].reverse().forEach(x => {
            tb.innerHTML += `<tr>
                <td>${formatDateOnly(x.date)}</td> 
                <td>${x.total}</td>
                <td>${x.speed || '-'}</td> 
                <td><button class="secondary-btn small-btn" onclick='showDetails(${JSON.stringify(x)})'>Ø¹Ø±Ø¶</button></td>
            </tr>`;
        });
    }

    function showDetails(x) {
        const tb = document.getElementById('modalRecordsBody');
        tb.innerHTML = '';
        
        const aiSummary = document.getElementById('modalAiSummary');
        let reportHTML = `<p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${x.total} Ø·Ù† / <strong>Ø§Ù„Ù…Ø¯Ø©:</strong> ${x.duration || '-'} Ø³Ø§Ø¹Ø©</p>`;
        reportHTML += `<p><strong>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©:</strong> ${x.speed || '-'} Ø·Ù†/Ø³Ø§Ø¹Ø©</p>`;
        
        if(x.aiReport && x.aiReport.length > 0) {
            reportHTML += `<h4>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:</h4><ul style="list-style: disc; margin-right: 20px;">${x.aiReport.map(i => `<li>${i}</li>`).join('')}</ul>`;
        } else {
             reportHTML += `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø°ÙƒÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©.</p>`;
        }
        aiSummary.innerHTML = reportHTML;


        x.records.forEach(r => {
            const diffColor = parseFloat(r.difference) > 0 ? 'green' : (parseFloat(r.difference) < 0 ? 'red' : 'inherit');
            tb.innerHTML += `
            <tr>
                <td>${formatDateTimeEnglish(r.dateTime)}</td>
                <td>${r.siloun}</td>
                <td>${r.weight}</td>
                <td style="color:${diffColor}">${r.difference}</td>
            </tr>
        `});
        document.getElementById('sessionDetailsModal').style.display = 'block';
    }

    function hideHistory() {
        document.getElementById('historyPage').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
    }
</script>

<script id="sw-script">
    // ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù sw.js Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ
    // Ù„ØªØ¨Ø³ÙŠØ· Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…ØŒ Ù†ÙØªØ±Ø¶ Ø£Ù†Ùƒ Ø³ØªØ­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…Ù„Ù "sw.js"
    /*
    const CACHE_NAME = 'molino-cache-v1';
    const urlsToCache = [
      'molino_app.html', 
      'molino_app.json',
      'icon-192.png', // *ÙŠØ¬Ø¨ ØªÙˆÙÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù
      'icon-512.png', // *ÙŠØ¬Ø¨ ØªÙˆÙÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js' 
    ];

    self.addEventListener('install', (event) => {
      event.waitUntil(
        caches.open(CACHE_NAME).then((cache) => {
            return cache.addAll(urlsToCache);
        })
      );
    });

    self.addEventListener('fetch', (event) => {
      event.respondWith(
        caches.match(event.request).then((response) => {
            if (response) return response;
            return fetch(event.request);
        })
      );
    });

    self.addEventListener('activate', (event) => {
      const cacheWhitelist = [CACHE_NAME];
      event.waitUntil(
        caches.keys().then((cacheNames) => {
          return Promise.all(
            cacheNames.map((cacheName) => {
              if (cacheWhitelist.indexOf(cacheName) === -1) {
                return caches.delete(cacheName);
              }
            })
          );
        })
      );
    });
    */
    
    // ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ø§Ù…Ù„ Ø§Ù„Ø®Ø¯Ù…Ø© Ù‡Ù†Ø§ (ÙÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ "sw.js" Ø¹Ù„Ù‰ Ø§ÙØªØ±Ø§Ø¶ Ø£Ù†Ùƒ Ø³ØªÙ†Ø´Ø¦ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ÙŠØ­ÙˆÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('PWA Service Worker registered successfully.'))
          .catch(err => console.log('PWA Service Worker registration failed:', err));
      });
    }

</script>

</body>
</html>
